!function($,window){var MapSVGAdminController=function(t,e,a,i){this.name=this.name||"controller",this.container="object"==typeof t?t:$("#"+t),this.admin=e,this.mapsvg=a,this.templates={},this.templatesURL=this.templatesURL||MapSVG.urls.templates,this.scrollable=void 0===this.scrollable||this.scrollable,this.controllers={},this.activeController=null,this.events=i||{},this._init()};MapSVGAdminController.prototype.nameCamel=function(){return this.name.split("-").map(function(t,e){return 0===e?t:t.charAt(0).toUpperCase()+t.slice(1)}).join("")},MapSVGAdminController.prototype.viewLoaded=function(){this.activeController&&this.activeController.viewDidAppear(),this.events.onload&&this.events.onload.call(this)},MapSVGAdminController.prototype.viewUnloaded=function(){this.events.unload&&this.events.unload.call(this)},MapSVGAdminController.prototype._viewLoaded=function(){this.loaded=!0,this.view.find(".mapsvg-select2").mselect2({minimumResultsForSearch:20}),this.scrollable&&this.updateScroll(),this.view.find(".mapsvg-onoff").bootstrapToggle({onstyle:"default",offstyle:"default"})},MapSVGAdminController.prototype.viewDidAppear=function(){var t=this;t.controllers&&t.activeController&&t.activeController.viewDidAppear(),this.scrollable&&t.updateScroll()},MapSVGAdminController.prototype.viewDidDisappear=function(){if(this.controllers)for(var t in this.controllers)this.controllers&&this.controllers[t]&&this.controllers[t].viewDidDisappear()},MapSVGAdminController.prototype.updateScroll=function(){if(this.contentWrap&&this.scrollable){var t=this.disableHorizontalScroll?{contentWidth:"0px"}:{};this.contentWrap.data("jsp")||this.contentWrap.jScrollPane(t);var e=this.contentWrap.data("jsp");e.reinitialise(),setTimeout(function(){e.reinitialise()},500)}},MapSVGAdminController.prototype._init=function(){var i=this;i.templatesLoaded?i.render():$.get(i.templatesURL+this.name+".hbs?"+Math.random(),function(t){$(t).each(function(t,e){var a=$(e).data("name");a&&(i.templates[a]=Handlebars.compile($(e).html()),$(e).data("partial")&&Handlebars.registerPartial(i.nameCamel()+MapSVG.ucfirst(a)+"Partial",$(e).html()))}),i.templatesLoaded=!0,i.render()})},MapSVGAdminController.prototype.render=function(){this.view&&this.view.empty().remove(),this.view=$("<div />").attr("id","mapsvg-admin-controller-"+this.name).addClass("mapsvg-view"),this.contentWrap=$("<div />").attr("id","mapsvg-admin-content-"+this.name).addClass("mapsvg-view-wrap"),this.contentView=$("<div />").addClass("mapsvg-view-content"),this.scrollable&&(this.contentWrap.addClass("nano"),this.contentView.addClass("nano-content")),this.contentWrap.append(this.contentView),this.templates.toolbar&&(this.toolbarView=$("<div />").attr("id","mapsvg-admin-toolbar-"+this.name).addClass("mapsvg-view-toolbar"),this.view.append(this.toolbarView)),this.view.append(this.contentWrap),this.container.append(this.view),this.container.data("controller",this),this.redraw(),this.setEventHandlersCommon(),this.setEventHandlers(),this._viewLoaded(),this.viewLoaded()},MapSVGAdminController.prototype.redraw=function(){this.templateData=this.getTemplateData(),this.contentView.html(this.templates.main(this.templateData)),this.templates.toolbar&&this.toolbarView.html(this.templates.toolbar(this.templateData)),this.scrollable&&this.updateScroll()},MapSVGAdminController.prototype.setMainTemplate=function(t){t="image"==t?"image":"path",this.templates.main=this.templates[t]},MapSVGAdminController.prototype.getTemplateData=function(){return this.mapsvg.getOptions(!0,null,this.admin.getData().optionsDelta)},MapSVGAdminController.prototype.setEventHandlersCommon=function(){var i=this;new MapSVG.ResizeSensor(this.view[0],function(){i.scrollable&&i.updateScroll()}),i.view.on("click","a.mapsvg-toggle-visibility",function(){var t=$(this).data("toggle-visibility");$(t).toggle(),$(t).is(":visible")?$(this).text("Hide"):$(this).text("Read more")}),i.view.on("change paste",'[data-live="change"]',function(t){i.formToObjectUpdate(t)}).on("keyup paste",'[data-live="keyup"]',function(t){i.formToObjectUpdate(t)}).on("select",'[data-live="select"]',function(t){i.formToObjectUpdate(t)}).on("click",'[data-live="click"]',function(t){i.formToObjectUpdate(t)}).on("keypress","form.safarifix input",function(t){13!=t.which&&13!=t.keyCode||t.preventDefault()}).on("click","input.input-switch",function(){$(this).is(":checked")&&($(this).closest(".controls").find(".radio").next().attr("disabled","disabled"),$(this).parent().next().removeAttr("disabled"))}).on("change",".mapsvg-toggle-visibility",function(){$(this).closest(".btn-group");var t=!$(this).is(":checkbox")||MapSVG.parseBoolean($(this).prop("checked")),e=$(this).data("toggle-visibility"),a=$(this).data("toggle-visibility-reverse");e&&(t?$(e).show():$(e).hide()),a&&(t?$(a).hide():$(a).show()),i.scrollable&&i.updateScroll()}).on("click","button.mapsvg-toggle-visibility",function(t){t.preventDefault();var e=$(this).data("toggle-visibility");$(e).toggle(),i.scrollable&&i.updateScroll()}).on("click",".disabled",function(t){return t.preventDefault(),!1}).on("click",".btn-group-checkbox a",function(){var t=$(this),e=t.attr("data-toggle");setTimeout(function(){t.hasClass("active")?t.closest(".btn-group-checkbox").find("input.input-toggle-"+e).val("true"):t.closest(".btn-group-checkbox").find("input.input-toggle-"+e).val("")},200)}).on("click",".mapsvg-template-link",function(){var t=$(this).data("template");i.admin.getData().controllers.templates?($('#mapsvg-tabs-menu a[href="#tab_templates"]').tab("show"),$("#tab_templates").find("select").val(t).trigger("change")):($('#mapsvg-tabs-menu a[href="#tab_templates"]').tab("show"),setTimeout(function(){$("#tab_templates").find("select").val(t).trigger("change")},500))}).on("click",".mapsvg-tab-link",function(t){t.preventDefault(),$('#mapsvg-tabs-menu a[href="'+$(this).attr("href")+'"]').tab("show")})},MapSVGAdminController.prototype.setEventHandlers=function(){},MapSVGAdminController.prototype.show=function(){this.view.show()},MapSVGAdminController.prototype.hide=function(){this.view.hide()},MapSVGAdminController.prototype.destroy=function(){if(this.viewUnloaded(),this.view.empty().remove(),this.controllers)for(var t in this.controllers)this.controllers[t]&&this.controllers[t].view&&this.controllers[t].destroy()},MapSVGAdminController.prototype.objectUpdater=function(t){return this.admin.mapSvgUpdate(t)},MapSVGAdminController.prototype.formToObjectUpdate=function(t){var e=$(t.target);e.is(":radio")&&(e=e.closest(".form-group").find(":radio:checked"));parseInt($(e).data("delay"));e.closest(".form-group").removeClass("has-error");var a=this.validateInput(e);if(!(a instanceof TypeError))return this.formToObjectUpdater(a);e.closest(".form-group").addClass("has-error")},MapSVGAdminController.prototype.formToObjectUpdater=function(t){var e=this;for(var a in t)var i=a;e.admin.getData().optionsMode[e.admin.getData().mode].hasOwnProperty(i)?$.extend(!0,e.admin.getData().optionsDelta,t):e.mapsvg.update(t)},MapSVGAdminController.prototype.mapSvgUpdateFinal=function(t){var e=this,a=e.validateInput(t);if(a instanceof TypeError)t.closest(".form-group").addClass("has-error");else{for(var i in a)var o=i;e.admin.getData().optionsMode[e.admin.getData().mode].hasOwnProperty(o)?$.extend(!0,e.admin.getData().optionsDelta,a):e.mapsvg.update(a)}},MapSVGAdminController.prototype.validateInput=function(jQueryElem){var val;val=jQueryElem.is(":checkbox")?!!jQueryElem.is(":checked")&&(!jQueryElem.attr("value")||"on"==jQueryElem.attr("value")||jQueryElem.attr("value")):jQueryElem.val();var validate=jQueryElem.data("validate");if(validate&&""!=val)if("function"==validate){if(val=""!=val?msvg.functionFromString(val):null,val instanceof TypeError||val instanceof SyntaxError)return val}else if("link"==validate){if(!MapSVG.isValidURL(val))return new TypeError('MapSVG error: wrong URL format. URL must start with "http://"')}else if("number"==validate){if(!$.isNumeric(val))return new TypeError("MapSVG error: value must be a number")}else if("object"==validate&&("["==data.substr(0,1)||"{"==data.substr(0,1)))try{var tmp;eval("tmp = "+val);var val=tmp}catch(t){return new TypeError("MapSVG error: wrong object format for "+jQueryElem.attr("name"))}return jQueryElem.inputToObject(val)},window.MapSVGAdminController=MapSVGAdminController}(jQuery,window);
!function(t,e){var a=function(t,e,a){this.name="actions",MapSVGAdminController.call(this,t,e,a)};e.MapSVGAdminActionsController=a,MapSVG.extend(a,e.MapSVGAdminController),a.prototype.viewLoaded=function(){this.updateDirSource()},a.prototype.setEventHandlers=function(){var t=this;this.mapsvg.regionsDatabase.on("schemaChange",function(){t.render()}),this.mapsvg.database.on("schemaChange",function(){t.render()})},a.prototype.updateDirSource=function(t){t=t||this.mapsvg.getData().options.menu.source,this.view.find("#mapsvg-dir-object").html("database"==t?"Database object":"Region object"),this.view.find("#mapsvg-dir-source").html("database"==t?"Database":"Regions"),"database"==t?this.view.find("#mapsvg-dir-link").attr("href","#").data("template","detailsView").html("DB Object details view template"):this.view.find("#mapsvg-dir-link").attr("href","#").data("template","detailsViewRegion").html("Region details view template")},a.prototype.getTemplateData=function(){var t=MapSVGAdminController.prototype.getTemplateData.call(this);return t.databaseFields=this.mapsvg.database.getSchema().map(function(t){if("text"==t.type||"textarea"==t.type||"post"==t.type)return"post"==t.type?"Object.post.url":"Object."+t.name}),t.regionFields=this.mapsvg.regionsDatabase.getSchema().map(function(t){if("text"==t.type||"textarea"==t.type||"post"==t.type)return"Region."+t.name}),t}}(jQuery,window);
!function(r,e){var o=function(e,o,s){this.name="colors",MapSVGAdminController.call(this,e,o,s)};e.MapSVGAdminColorsController=o,MapSVG.extend(o,e.MapSVGAdminController),o.prototype.setEventHandlers=function(){var s=this,e=s.mapsvg.getData().options.colors.selected,o=s.mapsvg.getData().options.colors.hover;r("#mapsvg-controls-hover-brightness").ionRangeSlider({type:"single",grid:!0,min:-100,max:100,from:r.isNumeric(o)?o:0}),r("#mapsvg-controls-selected-brightness").ionRangeSlider({type:"single",grid:!0,min:-100,max:100,from:r.isNumeric(e)?e:0}),r(".mapsvg-color-brightness").on("change",":radio",function(){var e=r(this).closest(".mapsvg-color-brightness :radio:checked").val(),o=r(this).closest(".form-group");"color"==e?(o.find(".cpicker").show(),o.find(".irs").hide()):(o.find(".cpicker").hide(),o.find(".irs").show())}),r.isNumeric(e)?(r("#mapsvg-colors-selected :radio").eq(0).prop("checked",!1).parent().removeClass("active"),r("#mapsvg-colors-selected :radio").eq(1).prop("checked",!0).parent().addClass("active"),r("#mapsvg-colors-selected .cpicker").hide(),r("#mapsvg-colors-selected .irs").show()):(r("#mapsvg-colors-selected :radio").eq(0).prop("checked",!0).parent().addClass("active"),r("#mapsvg-colors-selected :radio").eq(1).prop("checked",!1).parent().removeClass("active"),r("#mapsvg-colors-selected .cpicker").show().find("input").val(e),r("#mapsvg-colors-selected .irs").hide()),r.isNumeric(o)?(r("#mapsvg-colors-hover :radio").eq(0).prop("checked",!1).parent().removeClass("active"),r("#mapsvg-colors-hover :radio").eq(1).prop("checked",!0).parent().addClass("active"),r("#mapsvg-colors-hover .cpicker").hide(),r("#mapsvg-colors-hover .irs").show()):(r("#mapsvg-colors-hover :radio").eq(0).prop("checked",!0).parent().addClass("active"),r("#mapsvg-colors-hover :radio").eq(1).prop("checked",!1).parent().removeClass("active"),r("#mapsvg-colors-hover .cpicker").show().find("input").val(o),r("#mapsvg-colors-hover .irs").hide()),r("#mapsvg-controls-gauge").on("change",":radio",function(){var e=MapSVG.parseBoolean(r("#mapsvg-controls-gauge :radio:checked").val());r("#table-regions").removeClass("mapsvg-gauge-on"),e&&r("#table-regions").addClass("mapsvg-gauge-on"),e?r("#mapsvg-gauge-options").show():r("#mapsvg-gauge-options").hide(),s.admin.updateScroll()}),s.view.find(".cpicker").colorpicker().on("changeColor.colorpicker",function(e){var o=r(this).find("input");""==o.val()&&r(this).find("i").css({"background-color":""}),s.formToObjectUpdate({target:o[0]})})}}(jQuery,window);
!function(t,e){var s=function(e,t,s){this.name="css",this.disableHorizontalScroll=!0,MapSVGAdminController.call(this,e,t,s)};e.MapSVGAdminCssController=s,MapSVG.extend(s,e.MapSVGAdminController),s.prototype.viewLoaded=function(){var i=this;this.editors={},this.textarea=this.view.find("#mapsvg-css-editor"),this.textarea.val(i.admin.getData().options.mapsvg_css),0==this.textarea.val().length&&this.textarea.val("/* Add your styles here */\n\n\n\n\n\n\n\n\n"),this.editors.css=CodeMirror.fromTextArea(this.textarea[0],{mode:"css",matchBrackets:!0,lineNumbers:!0});this.editors.css.on("change",function(e,t){var s=e.getValue();i.admin.mapsvgCss=s,i.admin.mapsvgCssChanged=!0,i.mapsvg.setCss(s)}),t(e).on("resize.codemirror.css",function(){i.resizeEditor()}),i.resizeEditor(),i.exampleCode=null,i.cssCodeLoaded=!1,this.view.on("click","#mapsvg-css-menu a",function(e){e.preventDefault(),t(this).tab("show"),"#mapsvg-css-default"==t(this).attr("href")?i.cssCodeLoaded?i.highlighDefaultCss():t.get(i.mapsvg.getCssUrl(),function(e){t("#mapsvg-css-default-editor").val(e),i.highlighDefaultCss(),i.cssCodeLoaded=!0}):i.exampleCode&&i.exampleCode.toTextArea()}).on("shown.bs.tab",function(e){i.resizeEditor()})},s.prototype.resizeEditor=function(){this.view.find(".CodeMirror")[0].CodeMirror.setSize(null,this.contentWrap.height()),this.view.find(".CodeMirror").height(this.contentWrap.height())},s.prototype.highlighDefaultCss=function(){this.exampleCode=CodeMirror.fromTextArea(t("#mapsvg-css-default-editor")[0],{mode:"css",lineNumbers:!0,matchBrackets:!0,readOnly:!0}),this.resizeEditor()},s.prototype.init=function(){}}(jQuery,window);
!function(i,t){var a=function(t,a,e){this.name="database",this.scrollable=!1,this.isParent=!0,this.database=e.getDatabaseService(),MapSVGAdminController.call(this,t,a,e)};t.MapSVGAdminDatabaseController=a,MapSVG.extend(a,t.MapSVGAdminController),a.prototype.viewLoaded=function(){var t=this;this.controllers.list=new MapSVGAdminDatabaseListController("mapsvg-data-list",t.admin,t.mapsvg),this.controllers.structure=new MapSVGAdminDatabaseStructureController("mapsvg-data-structure",t.admin,t.mapsvg),this.controllers.settings=new MapSVGAdminDatabaseSettingsController("mapsvg-data-settings",t.admin,t.mapsvg),this.controllers.csv=new MapSVGAdminDatabaseCsvController("mapsvg-data-csv",t.admin,t.mapsvg),this.controllers.csv.toolbarView=this.toolbarView,this.controllers.list.toolbarView=this.toolbarView,this.controllers.structure.toolbarView=this.toolbarView,this.controllers.settings.toolbarView=this.toolbarView,t.activeController=this.controllers.list,MapSVGAdminController.prototype.viewLoaded.call(this)},a.prototype.viewDidAppear=function(){MapSVGAdminController.prototype.viewDidAppear.call(this);var t=this;t.activeController&&t.activeController instanceof MapSVGAdminDatabaseStructureController&&(t.admin.rememberPanelsState(),t.admin.togglePanel("left",!1))},a.prototype.viewDidDisappear=function(){MapSVGAdminController.prototype.viewDidDisappear.call(this),this.admin.restorePanelsState()},a.prototype.setEventHandlers=function(){var s=this;s.database.on("dataLoaded",function(){s.setFilters()}),this.view.on("click",".mapsvg-filter-delete",function(){var t=i(this).data("filter");delete s.mapsvg.database.query.filters[t],"search"===t&&i("#mapsvg-data-search").val(""),s.mapsvg.loadDataObjects(),s.setFilters(),s.controllers.list.redrawDataList(),_}),i("#mapsvg-data-menu a").click(function(t){t.preventDefault(),i(this).tab("show")}).on("shown.bs.tab",function(t){var a=i(i(this).attr("href")).data("controller");(s.activeController=a).viewDidAppear();var e=i(t.relatedTarget).attr("href");if(e){var r=i(e).attr("data-controller");s.controllers[r].viewDidDisappear()}"#mapsvg-data-structure"==i(this).attr("href")?(s.admin.rememberPanelsState(),s.admin.togglePanel("left",!1)):s.admin.restorePanelsState(),"#mapsvg-data-list"==i(this).attr("href")&&i(".mapsvg-toolbar-buttons").show()})},a.prototype.setFilters=function(t){var a=this;t=this.toolbarView.find(".mapsvg-toolbar-filters").empty();if(a.mapsvg.database.query.filters&&0<Object.keys(a.mapsvg.database.query.filters).length)for(var e in a.mapsvg.database.query.filters)t.append('<div class="mapsvg-filter-tag">'+e+": "+a.mapsvg.database.query.filters[e]+' <span class="mapsvg-filter-delete" data-filter="'+e+'">×</span></div>');var r=document.getElementById("mapsvg-admin-controller-database");r.style.display="none",r.offsetHeight,r.style.display="flex"}}(jQuery,window);
!function(o,e){var r=function(e,r,t){this.name="database-csv",this.database=t.getDatabaseService(),MapSVGAdminController.call(this,e,r,t)};e.MapSVGAdminDatabaseCsvController=r,MapSVG.extend(r,e.MapSVGAdminController),r.prototype.setEventHandlers=function(){var t=this;this.view.find("#mapsvg-btn-csv-upload").on("click",function(){o(this);o("#mapsvg-csv-file")[0].files[0]?Papa.parse(o("#mapsvg-csv-file")[0].files[0],{header:!0,complete:function(e){if(0===e.errors.length)t.import(e.data);else{var r="Errors: \n";r+=e.errors.map(function(e){return e.message+(void 0!==e.row?" (row: "+e.row+")":"")}).slice(0,5).join("\n"),5<e.errors.length&&(r+="\n...and "+(e.errors.length-5)+" more. "),alert(r)}}}):o.growl.error({title:"",message:"Please choose a file"})})},r.prototype.import=function(e){var r=o("#mapsvg-btn-csv-upload");r._button("loading");this.database.import(e).done(function(e){o.growl.notice({title:"",message:"File uploaded"})}).always(function(){r._button("reset")}).fail(function(){o.growl.error({title:"",message:"Server error"})})}}(jQuery,window);
!function(r,a){var t=function(a,t,e){var i=this;this.name="database-list",this.database=e.getDatabaseService(),this.database.on("schemaChange",function(){i.redrawDataList()}),i.database.on("dataLoaded",function(){i.redrawDataList()}),MapSVGAdminController.call(this,a,t,e)};a.MapSVGAdminDatabaseListController=t,MapSVG.extend(t,a.MapSVGAdminController),t.prototype.viewLoaded=function(){this.redrawDataList(),this.btnAdd=r("#mapsvg-btn-data-add")},t.prototype.viewDidAppear=function(){MapSVGAdminController.prototype.viewDidAppear.call(this),this.databaseTimestamp<this.database.lastChangeTime&&this.redrawDataList()},t.prototype.viewDidDisappear=function(){MapSVGAdminController.prototype.viewDidDisappear.call(this),this.closeFormHandler()},t.prototype.setEventHandlers=function(){var t,o=this;r("#mapsvg-data-search").on("keyup",function(){t&&clearTimeout(t);var a=this;t=setTimeout(function(){o.mapsvg.database.getAll({filters:{search:r(a).val()}}),o.redrawDataList()},300)}),r("#mapsvg-data-search-cols").on("click","li a",function(a){a.preventDefault();var t=r(this).text();r(this).closest(".input-group").find(".mapsvg-serch-field").text(t),o.searchField=t}),this.toolbarView.on("click",".mapsvg-data-cols a",function(a){a.preventDefault(),r(this).closest("li").toggleClass("active");var t=o.database.getSchema(),e=r(this).data("field");for(var i in t)e==t[i].name&&(t[i].visible=!t[i].visible);o.database.saveSchema(t)}),r("#mapsvg-btn-data-add").on("click",function(a){a.preventDefault(),o.editDataObject()}),this.view.on("click",".mapsvg-data-row",function(a){r(this).hasClass("active")||o.editDataObject(r(this).data("id"))}).on("click",".mapsvg-data-delete",function(a){a.preventDefault(),a.stopPropagation();var t=r(this).closest("tr");o.deleteDataRow(t)}).on("click",".mapsvg-data-copy",function(a){a.preventDefault(),a.stopPropagation(),o.copyDataObject(r(this).closest("tr").data("id"))})},t.prototype.getTemplateData=function(){return{fields:this.getDataFieldsForTemplate(!0),data:this.database.getLoaded()}},t.prototype.getDataFieldsForTemplate=function(t){var e=[{name:"id",visible:!0,type:"id"}],a=this.database.getSchema();for(var i in a&&a.forEach(function(a){return t?a.visible?e.push(a):void 0:e.push(a)}),e)"region"==e[i].type&&(e[i].options=[],e[i].optionsDict={},this.mapsvg.getData().regions.forEach(function(a){e[i].options.push({id:a.id,title:a.title}),e[i].optionsDict[a.id]=a.title?a.title:a.id}));return e},t.prototype.redrawDataList=function(){var a=this;a.redraw();var t=a.database.getColumns();t.length<2&&(r("#mapsvg-data-list-table").hide(),r("#mapsvg-setup-database-msg").show());var e=a.toolbarView.find(".mapsvg-data-cols");e.empty(),t.forEach(function(a){e.append(r('<li class="'+(a.visible?"active":"")+'"><a href="#" data-field="'+a.name+'">'+a.name+"</a></li>"))});var i=this.mapsvg.getPagination(function(){a.redrawDataList()});this.view.find(".mapsvg-pagination-container").html(i)},t.prototype.addDataRow=function(a){var t=this,e={fields:t.database.getColumns({visible:!0}),params:a};for(var i in e.fields)"region"==e.fields[i].type&&(e.fields[i].options=[],e.fields[i].optionsDict={},t.mapsvg.getData().regions.forEach(function(a){e.fields[i].options.push({id:a.id,title:a.title}),e.fields[i].optionsDict[a.id]=a.title?a.title:a.id}));var o=r(t.templates.item(e));return this.view.find("#mapsvg-data-list-table tbody").prepend(o),o},t.prototype.updateDataRow=function(a,t){var e=this,i={fields:e.database.getColumns({visible:!0}),params:a};for(var o in i.fields)"region"==i.fields[o].type&&(i.fields[o].options=[],i.fields[o].optionsDict={},e.mapsvg.getData().regions.forEach(function(a){i.fields[o].options.push({id:a.id,title:a.title}),i.fields[o].optionsDict[a.id]=a.title?a.title:a.id}));var s=r(e.templates.item(i));(t=t||r("#mapsvg-data-"+a.id)).replaceWith(s),s.addClass("mapsvg-row-updated"),setTimeout(function(){s.removeClass("mapsvg-row-updated")},2600)},t.prototype.deleteDataRow=function(a){var t=a.data("id"),e=this.database.getLoadedObject(t);e.location&&e.location.marker&&e.location.marker.delete(),this.database.delete(t),a.fadeOut(300,function(){a.remove()})},t.prototype.editDataObject=function(a,t,e){var i=this;a=a||{},newRecord="string"!=typeof a&&"number"!=typeof a||(a=i.database.getLoadedObject(a),!1),e=!0===e||!newRecord,i.btnAdd.addClass("disabled"),i.tableDataActiveRow&&i.tableDataActiveRow.removeClass("mapsvg-row-selected"),a&&a.id&&(newRecord=!1,i.updateScroll(),i.tableDataActiveRow=r("#mapsvg-data-"+a.id),i.tableDataActiveRow.addClass("mapsvg-row-selected"),t&&i.contentWrap.data("jsp").scrollToElement(i.tableDataActiveRow,!0,!1)),i.admin.mediaUploader||(i.admin.mediaUploader=wp.media.frames.file_frame=wp.media({title:"Choose images",button:{text:"Choose images"},multiple:!0})),i.formBuilder&&(i.formBuilder.destroy(),i.formBuilder=null,i.formBuilderRow&&i.formBuilderRow.remove()),i.formContainer&&i.formContainer.empty().remove(),i.formContainer=r('<div class="mapsvg-modal-edit"></div>'),this.view.append(i.formContainer);a.marker&&a.marker.id&&a.marker.id;i.formBuilder=new MapSVG.FormBuilder({container:i.formContainer,schema:i.database.getSchema(),editMode:!1,mapsvg:i.mapsvg,mediaUploader:i.admin.mediaUploader,data:a,admin:i.admin,closeOnSave:e,events:{save:function(a){newRecord?(i.formBuilder.marker&&(i.unsavedMarker=i.formBuilder.marker),i.saveDataObject(a).done(function(){})):i.updateDataObject(a).done(function(){}),e?this.close():(i.formBuilder.redraw(),i.mapsvg.hideMarkersExceptOne())},close:function(){i.closeFormHandler()},init:function(a){var t=a.location&&a.location.marker?a.location.marker.id:null;i.mapsvg.hideMarkersExceptOne(t)}}})},t.prototype.copyDataObject=function(a){var t={};if(r.extend(t,this.database.getLoadedObject(a)),t.id=null,t.location&&t.location instanceof MapSVG.Location){var e=t.location.toJSON();t.location=new MapSVG.Location(e),new MapSVG.Marker({location:t.location,mapsvg:this.mapsvg,object:t})}this.editDataObject(t,!1,!0)},t.prototype.saveDataObject=function(a){var t=this,e=this.addDataRow(a);return this.database.create(a).done(function(a){t.updateDataRow(a,e),a.location&&t.unsavedMarker&&a.location.marker.setObject(a)}).fail(function(){r.growl.error({title:"Server error",message:"Can't create object"}),e.remove()})},t.prototype.updateDataObject=function(a){if(a.marker){var t=this.mapsvg.getMarker(a.marker.id);t.setId("marker_"+a.id),t.setObject(a)}return this.closeFormHandler(),this.updateDataRow(a),this.database.update(a).fail(function(){r.growl.error({title:"Server error",message:"Can't update object"})})},t.prototype.closeFormHandler=function(){var a=this;a.btnAdd.removeClass("disabled"),a.mapsvg.showMarkers(),a.formBuilder&&(a.formBuilder.destroy(),a.formBuilder=null,a.formContainer.empty().remove(),a.tableDataActiveRow&&a.tableDataActiveRow.removeClass("mapsvg-row-selected"),a.tableDataActiveRow&&!a.tableDataActiveRow.hasClass("mapsvg-row-updated")&&a.tableDataActiveRow.addClass("mapsvg-row-closed"),setTimeout(function(){a.tableDataActiveRow&&!a.tableDataActiveRow.hasClass("mapsvg-row-updated")&&a.tableDataActiveRow.removeClass("mapsvg-row-closed")},1600),r("a.browser").remove(),"editMarkers"==a.admin.getData().mode&&a.admin.setPreviousMode()),this.updateScroll()}}(jQuery,window);
!function(a,e,s){s.DatabaseService=function(e,t){var r=this;this.mapsvg=t,this.map_id=e.map_id,this.table=e.table,this.perpage=parseInt(e.perpage)||0,this.sortBy=e.sortBy||null,this.sortDir=e.sortDir||null,this.type=e.type||"mysql",this.loaded=!1,"local"==this.type&&(this.dbObject=e.dbObject),this.server="mysql"==this.type?new s.ServerMySQL({map_id:this.map_id,table:this.table,perpage:this.perpage,mapsvg:this.mapsvg}):new s.ServerLocal({storage:this.dbObject}),this.lastChangeTime=Date.now(),this.cols=[],this.schemaDict={},this.index={},this.page=1,this.query=new s.DatabaseQuery,this.events={create:[],update:[],change:[],schemaChange:[],dataLoaded:[]},this.schema=new s.DatabaseSchema(e,t),this.schema.on("change",function(){r.getAll(),r.trigger("schemaChange")})},s.DatabaseService.setQuery=function(e){},s.DatabaseService.prototype.setPerpage=function(e){this.server.perpage=e},s.DatabaseService.prototype.lastChangeTime=function(){return this.lastChangeTime},s.DatabaseService.prototype.onFirstPage=function(){return 1===this.query.page},s.DatabaseService.prototype.onLastPage=function(){return!1===this.server.hasMoreRecords},s.DatabaseService.prototype.import=function(e){var t=this;return e=this.formatCSV(e),this.server.import(e).done(function(){t.getAll()})},s.DatabaseService.prototype.create=function(e){var t=this,r=a.extend({},e);return r.post&&delete r.post,this.server.create(r).done(function(){t.trigger("create"),t.trigger("change")})},s.DatabaseService.prototype.update=function(e){var t=this,r=(this.index[e.id],a.extend({},e));return r.post&&delete r.post,this.server.update(r).done(function(){t.trigger("update"),t.trigger("change")})},s.DatabaseService.prototype.delete=function(e){var t=this;return this.server.delete(e).done(function(){t.trigger("delete"),t.trigger("change")})},s.DatabaseService.prototype.clear=function(e){var t=this;return this.server.clear().done(function(){t.getAll(),t.trigger("delete"),t.trigger("change")})},s.DatabaseService.prototype.getLoadedObject=function(e){return this.server.getLoadedObject(e)},s.DatabaseService.prototype.getAll=function(e){var t=this;"object"==typeof e&&Object.keys(e).length&&!e.page&&(t.query.page=1),t.query.set(e),this.page=e&&e.page?parseInt(e.page):this.page;var r={search:t.query.search,searchField:t.query.searchField,searchFallback:t.query.searchFallback,filters:t.query.filters,filterout:t.query.filterout,page:this.page,sortBy:this.sortBy,sortDir:this.sortDir,perpage:void 0!==t.query.perpage?parseInt(t.query.perpage):this.perpage};return this.schema.loaded()||(r.with_schema=!0),this.server.get(r).done(function(e){!t.schema.loaded()&&e.schema&&t.schema.set(e.schema),t.loaded=!0,t.trigger("dataLoaded")})},s.DatabaseService.prototype.getLoaded=function(){return this.server.rows},s.DatabaseService.prototype.formatData=function(e){return e},s.DatabaseService.prototype.formatCSV=function(n){var o=this;return n.forEach(function(e,t){var r={};for(var a in e){var s=o.schema.getField(a);if(void 0!==s)switch(s.type){case"region":r[a]=e[a].split(",").map(function(e){return e.trim()}).filter(function(e){return void 0!==o.mapsvg.getRegion(e)}).map(function(e){return{id:e,title:o.mapsvg.getRegion(e).title}});break;case"location":if(e[a].match(/^(\-?\d+(\.\d+)?),\s*(\-?\d+(\.\d+)?)$/g)){var i=e[a].split(",").map(function(e){return parseFloat(e)});2==i.length&&-90<i[0]&&i[0]<90&&-180<i[1]&&i[1]<180?r[a]={lat:i[0],lng:i[1]}:r[a]=""}else e[a]&&(r[a]={address:e[a]});break;case"select":case"radio":case"text":case"textarea":case"status":default:r[a]=e[a]}}n[t]=r}),n},s.DatabaseService.prototype.on=function(e,t){this.lastChangeTime=Date.now(),this.events[e]||(this.events[e]=[]),this.events[e].push(t)},s.DatabaseService.prototype.trigger=function(e){var t=this;this.events[e]&&this.events[e].length&&this.events[e].forEach(function(e){e&&e(t.server.rows)})},s.DatabaseService.prototype.onSchemaChange=function(e){this.onSchemaChangeCallbacks.push(e)},s.DatabaseService.prototype.getSchema=function(e){return this.schema.get(e)},s.DatabaseService.prototype.getSchemaField=function(e){return this.schema.getField(e)},s.DatabaseService.prototype.getSchemaFieldByType=function(e){return this.schema.getFieldByType(e)},s.DatabaseService.prototype.setSchema=function(e){return this.schema.set(e)},s.DatabaseService.prototype.loadSchema=function(e){return this.schema.load(e)},s.DatabaseService.prototype.saveSchema=function(e){return this.schema.save(e)},s.DatabaseService.prototype.getColumns=function(e){return this.schema.getColumns(e)},s.DatabaseSchema=function(e,t){this.mapsvg=t,this.map_id=e.map_id,this.table=e.table,this.lastChangeTime=Date.now(),this.cols=[],this.schema=[],this.schemaDict={},this.events={create:[],update:[],change:[]}},s.DatabaseSchema.prototype.loaded=function(e){return 0!==this.schema.length},s.DatabaseSchema.prototype.set=function(e){var t=this;e&&(t.schema=e.map(function(e){return e.visible=s.parseBoolean(e.visible),t.schemaDict[e.name]=e}))},s.DatabaseSchema.prototype.save=function(e){var t=this;for(var r in this.set(e),this.schema)this.schema[r]||this.schema.splice(r,1);return e=(e=(e=(e=(e=JSON.stringify(e)).replace(/select/g,"!mapsvg-encoded-slct")).replace(/table/g,"!mapsvg-encoded-tbl")).replace(/database/g,"!mapsvg-encoded-db")).replace(/varchar/g,"!mapsvg-encoded-vc"),a.post(ajaxurl,{action:"mapsvg_save_schema",schema:e,map_id:this.map_id,table:this.table}).done(function(){t.trigger("change")})},s.DatabaseSchema.prototype.get=function(e){return this.schema},s.DatabaseSchema.prototype.getField=function(e){return"id"==e?{name:"id",visible:!0,type:"id"}:this.schemaDict[e]},s.DatabaseSchema.prototype.getFieldByType=function(t){var r=null;return this.schema.forEach(function(e){e.type===t&&(r=e)}),r},s.DatabaseSchema.prototype.load=function(e){var t=this;return a.get(ajaxurl,{action:"mapsvg_get_schema",map_id:this.map_id,table:this.table},null,"json").done(function(e){t.set(e)})},s.DatabaseSchema.prototype.getColumns=function(r){r=r||{};var e=this.get().slice(0);"regions"==this.table&&e.unshift({name:"title",visible:!0,type:"title"});var t=!0;e.forEach(function(e){"id"==e.name&&(t=!1)}),t&&e.unshift({name:"id",visible:!0,type:"id"});var a,s=0!==Object.keys(r).length,i=[];s?e.forEach(function(e){for(var t in a=!0,r)a=e[t]==r[t];a&&i.push(e)}):i=e;return i},s.DatabaseSchema.prototype.on=function(e,t){this.lastChangeTime=Date.now(),this.events[e]||(this.events={}),this.events[e].push(t)},s.DatabaseSchema.prototype.trigger=function(e){this.events[e]&&this.events[e].length&&this.events[e].forEach(function(e){e&&e()})},s.Server=function(e){this.index={},this.hasMoreRecords=!1},s.Server.prototype.reindex=function(){var r=this;this.index={},this.rows&&this.rows.forEach(function(e,t){r.index[e.id]=t})},s.Server.prototype.getLoadedObject=function(e){var t=this.index[e];return null!=t?this.rows[t]:{}},s.ServerMySQL=function(e){this.map_id=e.map_id,this.table=e.table,this.perpage=e.perpage,this.rows=[],s.Server.call(this)},s.extend(s.ServerMySQL,s.Server),s.ServerMySQL.prototype.formatData=function(e){var t={};for(var r in e)!e[r]||"object"!=typeof e[r]&&"function"!=typeof e[r]||null==e[r].getOptions?null===e[r]||void 0===e[r]||"object"==typeof e[r]&&0===e[r].length?t[r]="":t[r]=e[r]:t[r]=e[r].getOptions();return JSON.stringify(t)},s.ServerMySQL.prototype.actionData=function(e,t){return t.action=e,t.map_id=this.map_id,t.table=this.table,t.perpage=this.perpage,t},s.ServerMySQL.prototype.get=function(t){var r=this;return void 0!==t.perpage&&(this.perpage=t.perpage),a.getJSON(ajaxurl,this.actionData("mapsvg_data_get_all",t)).done(function(e){e.objects&&e.objects.length?(r.hasMoreRecords=t.perpage&&e.objects.length>t.perpage,r.hasMoreRecords&&e.objects.pop(),r.rows=e.objects):(r.hasMoreRecords=!1,r.rows=[]),r.reindex()})},s.ServerMySQL.prototype.import=function(e){return e=JSON.stringify(e),a.post(ajaxurl,this.actionData("mapsvg_data_import",{data:e}),null,"json").done(function(e){})},s.ServerMySQL.prototype.create=function(t){var r=this;this.rows.push(t);var e=this.formatData(t);return a.post(ajaxurl,this.actionData("mapsvg_data_create",{data:e}),null,"json").done(function(e){}).then(function(e){return t.id=e.id,r.reindex(),t})},s.ServerMySQL.prototype.update=function(e){var t=this.index[e.id];if(void 0!==t){this.rows[t]=e;var r=this.formatData(e);return a.post(ajaxurl,this.actionData("mapsvg_data_update",{data:r}),null,"json")}},s.ServerMySQL.prototype.delete=function(e){var t=this,r=this.index[e];return this.rows.splice(r,1),a.post(ajaxurl,this.actionData("mapsvg_data_delete",{data:{id:e}}),null,"json").done(function(){t.reindex()})},s.ServerMySQL.prototype.clear=function(e){var t=this;return a.post(ajaxurl,this.actionData("mapsvg_data_clear",{data:{}}),null,"json").done(function(){this.rows=[],t.reindex()})},s.ServerLocal=function(e){this.rows=e.storage,s.Server.call(this,e),this.reindex()},s.extend(s.ServerLocal,s.Server),s.ServerLocal.prototype.get=function(e){defer=a.Deferred();var t=this.rows;return defer.promise(),defer.resolve(t),defer},s.ServerLocal.prototype.create=function(e){if(e.id){var t=this.index[e.id];if(this.rows[t])return this.update(e)}else e.id=this.getId();return this.rows.push(e),this.reindex(),defer=a.Deferred(),defer.promise(),defer.resolve(e),defer},s.ServerLocal.prototype.update=function(e){defer=a.Deferred();var t=this.index[e.id];return this.rows[t]?a.extend(!0,this.rows[t],e):this.rows.push(e),this.reindex(),defer.promise(),defer.resolve(e),defer},s.ServerLocal.prototype.delete=function(e){var t=this.index[e];return this.rows.splice(t,1),this.reindex(),defer=a.Deferred(),defer.promise(),defer.resolve(this.storage),defer},s.ServerLocal.prototype.getId=function(){var e=this.rows.map(function(e){return e.id});return e.length||(e=[0]),e?Math.max.apply(null,e)+1:1},s.Filters=function(e){this.schema={},this.schemaDict={},this.fields={},this.events={change:[]},this.setSchema(e)},s.Filters.prototype.set=function(e){this.fields=e},s.Filters.prototype.save=function(e){this.fields=e},s.Filters.prototype.reset=function(e){this.fields={}},s.Filters.prototype.get=function(e){return this.fields},s.Filters.prototype.getField=function(e){return this.schemaDict[e]},s.Filters.prototype.getSchema=function(e){return this.schema},s.Filters.prototype.setSchema=function(e){var r=this;return e&&e.forEach(function(e){var t=e.parameterName.split(".")[1];r.schemaDict[t]=e}),this.schema=e,this.schema},s.Filters.prototype.on=function(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)},s.Filters.prototype.trigger=function(e){var t=this;this.events[e]&&this.events[e].length&&this.events[e].forEach(function(e){e&&e(t)})},s.DatabaseQuery=function(e){e=e||{},this.sortBy=e.sortBy||null,this.sortDir=e.sortDir||null,this.page=e.page||1,this.perpage=e.perpage,this.search=e.search,this.searchField=e.searchField,this.filters=e.filters||{},this.filterout=e.filterout||{}},s.DatabaseQuery.prototype.set=function(e){for(var t in e)"filters"==t?this.setFilters(e[t]):this[t]=e[t]},s.DatabaseQuery.prototype.setFilters=function(e){for(var t in e)null===e[t]||""===e[t]||void 0===e[t]?this.filters[t]&&delete this.filters[t]:this.filters[t]=e[t]},s.DatabaseQuery.prototype.setFilterOut=function(e){for(var t in e)this.filterout[t]=e[t]},s.DatabaseQuery.prototype.resetFilters=function(e){this.filters={}},s.DatabaseQuery.prototype.setFilterField=function(e,t){this.filters[e]=t}}(jQuery,window,MapSVG);
!function(a,e){var t=function(e,a,t){this.name="database-settings",this.database=t.getDatabaseService(),MapSVGAdminController.call(this,e,a,t)};e.MapSVGAdminDatabaseSettingsController=t,MapSVG.extend(t,e.MapSVGAdminController),t.prototype.setEventHandlers=function(){var e=this;this.view.on("click","#mapsvg-clear-database-btn",function(){confirm("Are you sure you want to clear the database?")&&e.database.clear().done(function(){a.growl.notice({title:"",message:"Database is cleared"})}).fail(function(){a.growl.error({title:"Server error",message:"Can't clear the database"})})})}}(jQuery,window);
!function(a,e){var t=function(e,t,a,i){this.name="database-structure",this.scrollable=!1,this.database=a.getDatabaseService(),MapSVGAdminController.call(this,e,t,a)};e.MapSVGAdminDatabaseStructureController=t,MapSVG.extend(t,e.MapSVGAdminController),t.prototype.viewDidAppear=function(){var t=this;MapSVGAdminController.prototype.viewDidAppear.call(this),t.formBuilder=new MapSVG.FormBuilder({schema:t.database.getSchema(),editMode:!0,mapsvg:t.mapsvg,admin:t.admin,container:this.contentView,events:{saveSchema:function(e){t.database.schema.get();t.mapsvg.id?t.database.saveSchema(e).done(function(){a.growl.notice({title:"",message:"Settings saved"}),t.admin.save()}).fail(function(){a.growl.error({title:"Server error",message:"Can't save settings"})}):t.admin.save().done(function(){t.database.map_id=t.mapsvg.id,t.database.saveSchema(e).done(function(){}).fail(function(){a.growl.error({title:"Error",message:"Can't save settings"})})}).fail(function(){a.growl.error({title:"Error",message:"Can't save settings"})})},load:function(){setTimeout(function(){a("#mapsvg-btn-database-structure").tooltip("show").tooltip("hide")},200)}}})},t.prototype.viewDidDisappear=function(){MapSVGAdminController.prototype.viewDidDisappear.call(this),this.formBuilder&&this.formBuilder.destroy()},t.prototype.setEventHandlers=function(){}}(jQuery,window);
!function(n,o){var t=function(n,o,t){this.name="details",MapSVGAdminController.call(this,n,o,t)};o.MapSVGAdminDetailsController=t,MapSVG.extend(t,o.MapSVGAdminController),t.prototype.viewLoaded=function(){}}(jQuery,window);
!function(r,t){var e=function(t,e,i){this.name="directory",MapSVGAdminController.call(this,t,e,i)};t.MapSVGAdminDirectoryController=e,MapSVG.extend(e,t.MapSVGAdminController),e.prototype.setEventHandlers=function(){var t=this.view.find("#mapsvg-directory-filterout");t.on("change","#mapsvg-directory-filter-control",function(){r(this).val()?t.find("#mapsvg-filterout-extra").show():t.find("#mapsvg-filterout-extra").hide()})},e.prototype.updateDirSource=function(t){t=t||this.mapsvg.getData().options.menu.source,this.view.find("#mapsvg-dir-object-2").html("database"==t?"Database object":"Region object")},e.prototype.setDatabase=function(t){this.database="regions"==t?this.mapsvg.regionsDatabase:this.mapsvg.database},e.prototype.viewLoaded=function(){var e=this;e.setDatabase(this.mapsvg.getData().options.menu.source),e.updateDirSource(),e.setSortFields(),this.mapsvg.database.on("schemaChange",function(){e.setSortFields()}),this.mapsvg.regionsDatabase.on("schemaChange",function(){e.setSortFields()}),this.view.find("#mapsvg-directory-data-source").on("change",":radio",function(){var t=r(this).val();e.setDatabase(t),e.setSortFields(),e.updateDirSource(t),e.admin.getData().controllers.actions&&e.admin.getData().controllers.actions.updateDirSource(t)}),this.view.find("#mapsvg-directory-sort-control").mselect2(),this.view.find("#mapsvg-directory-filter-control").mselect2(),this.view.find("#mapsvg-directory-filter-cond-control").mselect2(),this.view.on("change","#mapsvg-details-width :radio",function(){"full"!=r(this).closest(".form-group").find(":radio:checked").val()?r("#mapsvg-details-width-custom").prop("disabled",!1).trigger("keyup"):r("#mapsvg-details-width-custom").prop("disabled",!0)}),e.updateSortList()},e.prototype.updateSortList=function(){},MapSVGAdminController.prototype.getTemplateData=function(){var t=this.mapsvg.getOptions(!0,null,this.admin.getData().optionsDelta);return t.fulltext_min_word_len=mapsvg_fulltext_min_word,t},e.prototype.setSortFields=function(){var e=this,i="regions"==r("#mapsvg-directory-data-source :radio:checked").val()?["id","title"]:["id"],t=this.database.getSchema();t&&t.forEach(function(t){i.push(t.name)});var o=i.map(function(t){return"<option "+(e.templateData.menu.sortBy==t?"selected":"")+">"+t+"</option>"}),a=i.map(function(t){return"<option "+(e.templateData.menu.filterout.field==t?"selected":"")+">"+t+"</option>"});a.unshift('<option value="">(no filter)</option>'),this.view.find("#mapsvg-directory-sort-control").html(o).trigger("change"),this.view.find("#mapsvg-directory-filter-control").html(a).trigger("change"),this.view.find("#mapsvg-directory-filter-cond-control").val(e.templateData.menu.filterout.cond)}}(jQuery,window);
!function(i,t){var e=function(t,e,i){this.name="draw-region",this.svgObject=null,MapSVGAdminController.call(this,t,e,i)};t.MapSVGAdminDrawRegionController=e,MapSVG.extend(e,t.MapSVGAdminController),e.prototype.setEventHandlers=function(){var a=this;this.svgObject&&"image"==this.svgObject.tagName?a.view.on("change",".mapsvg-draw-image-upload",function(t){i.each(t.target.files,function(t,e){var i=new FileReader;i.onload=function(t){var e=t.target.result,i=new Image;i.onload=function(){a.drawer.updateShape(a.svgObject,{"xlink:href":e}),a.drawer.updateShape(a.svgObject,{width:this.width}),a.drawer.updateShape(a.svgObject,{height:this.height}),a.view.find('[name="width"]').val(this.width),a.view.find('[name="height"]').val(this.height)},i.src=e},i.readAsDataURL(e)})}):a.view.find(".cpicker").colorpicker().on("changeColor.colorpicker",function(t){var e=i(this).find("input");""==e.val()&&i(this).find("i").css({"background-color":""}),a.formToObjectUpdate({target:e[0]})})},e.prototype.setObject=function(t){this.svgObject=t,this.setMainTemplate(t.tagName),this.loaded&&(this.redraw(),this.setEventHandlers())},e.prototype.destroy=function(){this.view.find(".cpicker").colorpicker("destroy"),MapSVGAdminController.prototype.destroy.call(this)},e.prototype.viewUnloaded=function(){MapSVGAdminController.prototype.viewUnloaded.call(this)},e.prototype.setDrawer=function(t){this.drawer=t},e.prototype.formToObjectUpdater=function(t){this.drawer.updateShape(this.svgObject,t)},e.prototype.getTemplateData=function(){var t=this,e={};if(t.svgObject)switch(e={id:i(t.svgObject).data("new-id")?i(t.svgObject).data("new-id"):t.svgObject.getAttribute("id"),title:t.svgObject.getAttribute("title")},this.svgObject.tagName){case"path":case"ellipse":case"circle":case"rect":case"polygon":e.style={fill:i(t.svgObject).css("fill")||t.svgObject.getAttribute("fill"),stroke:i(t.svgObject).css("stroke")||t.svgObject.getAttribute("stroke"),"stroke-width":i(t.svgObject).data("stroke-width")};break;case"image":e.x=t.svgObject.getAttribute("x"),e.y=t.svgObject.getAttribute("y"),e.width=t.svgObject.getAttribute("width"),e.height=t.svgObject.getAttribute("height")}return e}}(jQuery,window);
!function(d,a){var t=function(t,e,a){this.name="draw",this.map=a.getData().$map,this.svg=a.getData().$svg,this.changed=!1,this.scrollable=!1,this.changes=[],this.mode="edit",this.snap=!0,this.lastClickTime=0,this.lastChangeTime=0,this.hints=[],this.hintHover="",MapSVGAdminController.call(this,t,e,a),this.filepath=this.mapsvg.getData().options.source,-1==this.filepath.indexOf(mapsvg_paths.uploads)&&(this.readOnly=!0)};a.MapSVGAdminDrawController=t,MapSVG.extend(t,a.MapSVGAdminController),t.prototype.viewDidAppear=function(){var t=this;MapSVGAdminController.prototype.viewDidAppear.call(this),this.defScroll=t.mapsvg.getData().options.scroll.on,t.mapsvg.setScroll({on:!1}),d("#mapsvg-save").hide(),d("#mapsvg-save-svg").show(),t.readOnly&&t.setReadOnly(!0),this.loaded&&t.setEventHandlers(),this.reindex()},t.prototype.reindex=function(t){for(var e=this.svg[0].getElementsByTagName("*"),a=0;a<e.length;a++)d(e[a]).data("index",a),this.lastindex=a},t.prototype.viewUnloaded=function(t){var e=this;MapSVGAdminController.prototype.viewUnloaded.call(e),d("#mapsvg-save-svg").hide(),d("#mapsvg-save").show(),e.mapsvg.eventsRestore(),e.mapsvg.setScroll({on:this.defScroll}),this.resaveMsg&&this.resaveMsg.remove(),e.editingShape&&(e.editingShape.unclosed?e.removeShape(e.editingShape.obj):e.editingShapeUnset()),e.controllers.region&&(e.admin.unloadController(e.controllers.region),e.controllers.region=null),d(a).off(".draw.mapsvg"),this.map.off(".draw.mapsvg"),this.view.off(),d("body").off("click.mapsvg-save-svg"),d("body").off("click.mapsvg-save-svg-copy"),e.hide(),e.viewDidDisappear()},t.prototype.viewLoaded=function(t){MapSVGAdminController.prototype.viewLoaded.call(this),this.hint()},t.prototype.setReadOnly=function(t){if(t){this.readOnly=!0,d("#mapsvg-admin").addClass("mapsvg-read-only"),d("#mapsvg-save-svg").prop("disabled",!0),this.resaveMsg=d('<div id="mapsvg-save-svg-copy-message" class="well"></div>'),this.resaveMsg.html('This SVG file is "read-only". Save a copy of the file into WP Uploads folder?<br /><br />');var e=d('<button class="btn btn-sm btn-primary" id="mapsvg-save-svg-copy" data-loading-text="Saving...">Save</button>');this.resaveMsg.append(e),d("#mapsvg-admin").append(this.resaveMsg)}else this.readOnly&&(this.readOnly=!1,d("#mapsvg-admin").removeClass("mapsvg-read-only"),d("#mapsvg-save-svg").prop("disabled",!1),this.resaveMsg.remove())},t.prototype.clickToSVG=function(t){var e=this,a=MapSVG.mouseCoords(t),i=a.x-e.svg.offset().left,n=a.y-e.svg.offset().top;return e.mapsvg.convertPixelToSVG([i,n])},t.prototype.setEventHandlers=function(){var o=this;switch(d(a).off(".draw.mapsvg"),this.map.off(".draw.mapsvg"),this.view.off(),this.view.on("mouseenter","#mapsvg-draw-tools .btn",function(t){d(this).data("hint")&&(o.hintHover=d(this).data("hint"),o.hint())}).on("mouseleave","#mapsvg-draw-tools .btn",function(t){d(this).data("hint")&&(o.hintHover=null,o.hint())}),this.mode){case"draw":o.mapsvg.eventsPrevent("click"),o.mapsvg.eventsPrevent("mouseover"),o.mapsvg.eventsPrevent("mouseout");o.map.on("click.draw.mapsvg",function(t){var e=o.clickToSVG(t),a=(new Date).getTime();a-o.lastClickTime<300?o.closePath():o.editingShape?o.addPointToPath(o.editingShape.lastPoint):o.startPath(e),o.lastClickTime=a});break;case"edit":o.mapsvg.eventsPrevent("click"),o.mapsvg.eventsPrevent("mouseover"),o.mapsvg.eventsPrevent("mouseout"),d(a).on("keyup.draw.mapsvg",function(t){t.preventDefault(),"INPUT"!=t.target.tagName&&8==t.keyCode&&(o.editingPoint?o.removeEditingPoint():o.editingShape&&o.removeShape(o.editingShape.obj))}),o.mapsvg.getData().$map.on("mouseover.draw.mapsvg",".mapsvg-region",function(){}),o.mapsvg.getData().$map.on("mouseout.draw.mapsvg",".mapsvg-region",function(){}),o.mapsvg.getData().$map.on("mousedown.draw.mapsvg",function(t){if(t.originalEvent.preventDefault(),d(t.target).hasClass("mapsvg-path-point-new")){var e=o.addNewPoint(o.editingShape.newPoint.getAttribute("cx"),o.editingShape.newPoint.getAttribute("cy"),t);o.dragPointStart(t,e)}else if(d(t.target).hasClass("mapsvg-path-point"))o.dragPointStart(t);else{if(-1===["path","image","circle","polyline","polygon","ellipse","rect"].indexOf(t.target.tagName))return!1;o.editingShape&&o.editingShape.obj===this||o.editShape(t.target),o.editingPoint&&o.editingPointUnset(),-1!==["path","image","polygon","polyline","rect","ellipse","circle"].indexOf(t.target.tagName)&&(o.dragShapeStart(t),o.mapsvg.getData().$map.on("mousemove.2.draw.mapsvg",function(t){o.dragShapeMove(t)}),o.mapsvg.getData().$map.on("mouseup.2.draw.mapsvg",function(t){o.dragShapeEnd(t)}))}}),o.mapsvg.getData().$map.on("mouseup.draw.mapsvg",".mapsvg-image-background",function(t){t.originalEvent.preventDefault(),o.editingShape&&o.editingShape.obj===this||o.editShape(this)}),o.editingShape&&(d(a).off("keyup.esc.draw.mapsvg"),d(a).on("keyup.esc.draw.mapsvg",function(t){27==t.keyCode&&o.editingShape&&o.editingShapeUnset()}),"path"==o.editingShape.obj.tagName&&o.mapsvg.getData().$map.on("mousemove.draw.mapsvg",function(t){var e=o.mapsvg.convertMouseToSVG(t);e={x:e[0],y:e[1]};var i=o.getIntersectionWithEditingShape(e);if(i){var n=o.mapsvg.getScale();o.editingShape.points.forEach(function(t){var e=t.getAttribute("cx"),a=t.getAttribute("cy");Math.abs(i.x-e)<10/n&&Math.abs(i.y-a)<10/n&&(i=!1)})}o.editingShape.newPoint.style.display=i?(o.editingShape.newPoint.setAttribute("cx",i.x),o.editingShape.newPoint.setAttribute("cy",i.y),"block"):"none"}))}d("body").off("click.mapsvg-save-svg"),d("body").on("click.mapsvg-save-svg","#mapsvg-save-svg",function(){o.saveSvg()}),this.view.on("change","#mapsvg-draw-mode input",function(t){o.setMode(d(this).val())}),this.view.on("change","#mapsvg-draw-btn-magnet",function(){o.setSnap(d(this).prop("checked"))}),this.view.on("click","#mapsvg-draw-undo",function(){o.undo()}),o.readOnly&&d("body").on("click.mapsvg-save-copy","#mapsvg-save-svg-copy",function(){d(this)._button("loading"),d.post(ajaxurl,{action:"mapsvg_svg_copy",filepath:o.filepath}).done(function(t){(t=jQuery.parseJSON(t)).filepath?(o.filepath=t.filepath,o.mapsvg.update({source:o.filepath}),o.admin.save(!0),o.setReadOnly(!1)):t.error&&alert(t.error)}).always(function(){d("#mapsvg-save-svg-copy")._button("reset")})})},t.prototype.drawStart=function(t){},t.prototype.drawMove=function(t){},t.prototype.drawEnd=function(t){},t.prototype.dragPointStart=function(t,e){var a=this;a.isDragging=!0;e=void 0!==e?e:d(t.target).data("index");a.editingShape.pathData=a.editingShape.obj.getPathData({normalize:!0});var i=a.editingShape.pathData[e];a.editingPoint&&a.editingPointUnset();var n=a.editingShape.points[e];d(n).addClass("active"),a.editingPoint={pointOriginal:d.extend(!0,{},i),circle:n,index:e},a.dragStartMouseCoords=a.clickToSVG(t),a.editingShape.d=a.editingShape.obj.getAttribute("d"),a.loadSnapPoints(),a.mapsvg.getData().$map.on("mousemove.dragpoint.draw.mapsvg",function(t){a.dragPointMove(t)}),a.mapsvg.getData().$map.on("mouseup.dragpoint.draw.mapsvg",function(t){a.dragPointEnd(t,i)}),a.hint()},t.prototype.dragPointMove=function(t){var e=this,a=e.clickToSVG(t),i=a[0]-e.dragStartMouseCoords[0],n=a[1]-e.dragStartMouseCoords[1],o=d.extend(!0,{},e.editingPoint.pointOriginal);o.values[0]+=i,o.values[1]+=n,this.snap&&(o.values=e.doSnap(o.values)),e.editingPoint.circle.setAttribute("cx",o.values[0]),e.editingPoint.circle.setAttribute("cy",o.values[1]),e.editingShape.pathData[e.editingPoint.index]=o,e.editingShape.obj.setPathData(e.editingShape.pathData)},t.prototype.dragPointEnd=function(t){var e=this;this.mapsvg.getData().$map.off("mousemove.dragpoint.draw.mapsvg"),this.mapsvg.getData().$map.off("mouseup.dragpoint.draw.mapsvg"),this.isDragging=!1;var a=e.clickToSVG(t);a[0]!=e.dragStartMouseCoords[0]&&a[1]!=e.dragStartMouseCoords[1]&&e.addChange("update",e.editingShape.obj,{d:e.editingShape.obj.getAttribute("d")},{d:e.editingShape.d}),e.loadIntersectionPoints()},t.prototype.getDragShapeProperties=function(t){var e=this;switch(e.editingShape.obj.tagName){case"path":return{d:e.editingShape.obj.getAttribute("d")};case"ellipse":case"circle":return{cx:parseFloat(e.editingShape.obj.getAttribute("cx")),cy:parseFloat(e.editingShape.obj.getAttribute("cy"))};case"image":case"rect":return{x:parseFloat(e.editingShape.obj.getAttribute("x")),y:parseFloat(e.editingShape.obj.getAttribute("y"))};case"polygon":case"polyline":return{points:parseFloat(e.editingShape.obj.getAttribute("points"))}}},t.prototype.dragShapeStart=function(t){var e=this;this.isDragging=!0,e.dragXY=e.clickToSVG(t),e.dragStartMouseCoords=e.dragXY,e.editingShape.dragProperties=e.getDragShapeProperties()},t.prototype.dragShapeMove=function(t,e,a){var i=this,n=i.clickToSVG(t),o=n[0]-i.dragXY[0],s=n[1]-i.dragXY[1];switch(i.editingShape.obj.tagName){case"path":(r=i.editingShape.obj.getPathData({normalize:!0})).forEach(function(t,e){if(t.values&&t.values.length){for(var a in t.values)t.values[a]+=a%2?s:o;t.values[t.values.length-2],t.values[t.values.length-1];i.editingShape.points[e].setAttribute("cx",t.values[0]),i.editingShape.points[e].setAttribute("cy",t.values[1])}}),i.editingShape.obj.setPathData(r);break;case"ellipse":case"circle":var p=parseFloat(i.editingShape.obj.getAttribute("cx"))+o,d=parseFloat(i.editingShape.obj.getAttribute("cy"))+s;i.editingShape.obj.setAttribute("cx",p),i.editingShape.obj.setAttribute("cy",d);break;case"image":case"rect":p=parseFloat(i.editingShape.obj.getAttribute("x"))+o,d=parseFloat(i.editingShape.obj.getAttribute("y"))+s;i.editingShape.obj.setAttribute("x",p),i.editingShape.obj.setAttribute("y",d);break;case"polygon":case"polyline":var r=i.editingShape.obj.getAttribute("points").replace(/\s\s+/g," ").split(" ");for(var g in r){var h=r[g].split(",");h[0]=parseFloat(h[0])+o,h[1]=parseFloat(h[1])+s,r[g]=h.join(",")}i.editingShape.obj.setAttribute("points",r.join(" "))}i.dragXY=n},t.prototype.dragShapeEnd=function(t){var e=this;this.mapsvg.getData().$map.off("mousemove.2.draw.mapsvg"),this.mapsvg.getData().$map.off("mouseup.2.draw.mapsvg"),this.isDragging=!1;var a=e.clickToSVG(t);a[0]!=e.dragStartMouseCoords[0]&&a[1]!=e.dragStartMouseCoords[1]&&e.addChange("update",e.editingShape.obj,e.getDragShapeProperties(),e.editingShape.dragProperties),"path"==e.editingShape.obj.tagName&&e.loadIntersectionPoints()},t.prototype.editShape=function(t){var o=this;if(o.editingShapeUnset(),o.editingShape={obj:t},"polygon"==t.tagName||"polyline"==t.tagName){var e=document.createElementNS("http://www.w3.org/2000/svg","path");for(var a in t.attributes)["points"].includes(a.name)||e.setAttribute(a.name,a.value);e.setPathData(t.getPathData({normalized:!0})),o.removeShape(t);var i=t.parentNode;t=e,i.appendChild(t),o.addChange("create",t),o.reindex();d(o.changes[o.changes.length-1].data).data("index")}o.editingShape={obj:t};var n=t.getAttribute("class")||"";if(n&&-1!=n.indexOf("active")||t.setAttribute("class",n+" active"),o.controllers.region&&(o.admin.unloadController(o.controllers.region),o.controllers.region=null),o.controllers.region=o.admin.loadController("tab_draw_region","drawRegion"),o.controllers.region.events={onload:function(){this.setObject(t)}},o.controllers.region.setDrawer(o),"path"==t.tagName){e=t.getPathData({normalize:!0});o.editingShape.points=[],e.forEach(function(t,e){if(t.values&&t.values.length){var a=document.createElementNS(o.svg[0].namespaceURI,"circle"),i=t.values[t.values.length-2],n=t.values[t.values.length-1];a.setAttribute("cx",i),a.setAttribute("cy",n),a.setAttribute("r",5/o.mapsvg.getScale()),a.setAttribute("class","mapsvg-path-point"),d(a).css("stroke-width",1),d(a).data("stroke-width",1),d(a).data("index",e),o.svg[0].appendChild(a),o.editingShape.points.push(a)}});var s=document.createElementNS(o.svg[0].namespaceURI,"circle");s.setAttribute("cx",0),s.setAttribute("cy",0),s.setAttribute("r",5/o.mapsvg.getScale()),s.setAttribute("class","mapsvg-path-point mapsvg-path-point-new"),d(s).css("stroke-width",1),d(s).data("stroke-width",1),d(s).hide(),o.svg[0].appendChild(s),o.editingShape.newPoint=s,o.loadIntersectionPoints(),o.mapsvg.mapAdjustStrokes(),o.mapsvg.on("zoom",function(){o.adjustPointsSize()})}o.setEventHandlers(),this.hint()},t.prototype.adjustPointsSize=function(){var e=this;e.editingShape&&(e.editingShape.points&&e.editingShape.points.forEach(function(t){t.setAttribute("r",5/e.mapsvg.getScale()),d(t).css("stroke-width",1/e.mapsvg.getScale())}),e.editingShape.newPoint&&(e.editingShape.newPoint.setAttribute("r",5/e.mapsvg.getScale()),d(e.editingShape.newPoint).css("stroke-width",1/e.mapsvg.getScale())))},t.prototype.editingPointUnset=function(){d(this.editingPoint.circle).removeClass("active"),this.editingPoint=null,this.hint()},t.prototype.editingShapeUnset=function(){var e=this;e.editingShape&&e.editingShape.obj&&(e.mapsvg.off("zoom"),e.editingShape.points&&e.editingShape.points.forEach(function(t){e.svg[0].removeChild(t)}),e.editingShape.newPoint&&(d(e.editingShape.newPoint).remove(),e.editingShape.newPoint=null),e.editingShape.stroke&&e.svg[0].removeChild(e.editingShape.stroke),-1!=e.editingShape.obj.getAttribute("class").indexOf("active")&&e.editingShape.obj.setAttribute("class",e.editingShape.obj.getAttribute("class").replace("active",""))),e.map.off("mousemove.draw.mapsvg"),this.editingShape=null,e.editingPoint=null,this.hint()},t.prototype.setMode=function(t){this.mode=t,this.editingShapeUnset(),this.setEventHandlers(),this.hint()},t.prototype.hint=function(t){if(this.hintHover)d("#mapsvg-draw-status-line").html(this.hintHover);else switch(this.mode){case"draw":this.editingShape&&this.editingShape.obj?this.setHint("<code>Click</code> to add point. <code>Enter</code>: close path. <code>Double Click</code>: add point & close path. <code>Esc</code>: cancel. Hold <code>Spacebar</code> to scroll."):this.setHint("<code>Click</code> to start drawing. Hold <code>Spacebar</code> to scroll.");break;case"edit":if(this.editingShape&&this.editingShape.obj)if(this.editingPoint)this.setHint("<b>Point</b>: <code>Backspace</code>: delete point. Hold  <code>Spacebar</code> to scroll.");else{var e=this.editingShape.obj.tagName;t="<b>"+this.editingShape.obj.tagName+"</b>";t+=": <code>Drag</code> the object"+("path"==e?" or its points":"")+". <code>Backspace</code>: delete object. Hold  <code>Spacebar</code> to scroll.",this.setHint(t)}else this.setHint("<code>Click</code> on an object to edit it. Hold  <code>Spacebar</code> to scroll.")}},t.prototype.setHint=function(t){d("#mapsvg-draw-status-line").html(t)},t.prototype.setSnap=function(t){this.snap=t,this.snap&&this.loadSnapPoints()},t.prototype.startPath=function(t){var e=this;return e.editingShape={},e.editingShape.unclosed=!0,e.editingShape.obj=document.createElementNS(e.svg[0].namespaceURI,"path"),e.editingShape.obj.setAttribute("d","M"+t[0]+" "+t[1]+" "),e.editingShape.d=e.editingShape.obj.getAttribute("d"),e.editingShape.lastPoint=t,e.editingShape.obj.setAttribute("class","active mapsvg-custom-shape mapsvg-region"),d(e.editingShape.obj).css({fill:"rgba(255,0,0,0.4)",stroke:"rgba(255,100,100,0.4)"}),e.svg[0].appendChild(e.editingShape.obj),e.loadSnapPoints(),e.map.on("mousemove.draw.mapsvg",function(t){e.moveLastPathPoint(t)}),d(a).off("keyup.draw.mapsvg"),d(a).on("keyup.draw.mapsvg",function(t){13==t.keyCode?e.closePath():27==t.keyCode&&e.editingShape&&(e.editingShape.unclosed?(e.removeShape(e.editingShape.obj),e.map.off("mousemove.draw.mapsvg")):e.editingShapeUnset())}),this.hint(),e.editingShape},t.prototype.moveLastPathPoint=function(t){var e=this;e.editingShape.lastPoint=e.clickToSVG(t),this.snap&&(e.editingShape.lastPoint=e.doSnap(e.editingShape.lastPoint)),e.editingShape.obj.setAttribute("d",e.editingShape.d+"L"+e.editingShape.lastPoint[0]+" "+e.editingShape.lastPoint[1]+" ")},t.prototype.closePath=function(){var t=this;t.editingShape.obj.setAttribute("d",t.editingShape.d+"L"+t.editingShape.lastPoint[0]+" "+t.editingShape.lastPoint[1]+" "),t.editingShape.obj.setAttribute("d",t.editingShape.d+"z");var e=prompt("Enter Region ID");e?(t.editingShape.obj.setAttribute("id",e),t.addChange("create",t.editingShape.obj),d(t.editingShape.obj).data("index",++t.lastindex),t.editingShape=null):t.removeShape(t.editingShape.obj),this.hint(),t.map.off("mousemove.draw.mapsvg"),d(a).off("keyup.draw.mapsvg")},t.prototype.addPointToPath=function(t){var e=this;return e.editingShape.obj.setAttribute("d",e.editingShape.d+"L"+t[0]+" "+t[1]+" "),e.editingShape.d=e.editingShape.obj.getAttribute("d"),e.editingShape},t.prototype.updateShape=function(t,e,a){var i=this,n={},o="string"==typeof t?i.svg.find("#"+t)[0]:t;for(var s in e)if("style"==s&&"string"!=typeof e[s]){for(var p in n.style={},e[s])n.style[p]=d(o).css(p)||o.getAttribute(p),o.getAttribute(p)&&o.removeAttribute(p);"stroke-width"==p?(d(o).data("stroke-width",e[s][p]),i.mapsvg.mapAdjustStrokes()):d(o).css(e[s]),!a&&i.addChange("update",o,e,n)}else n[s]="id"==s?i.getObjectId(o):o.getAttribute(s),!a&&i.addChange("update",o,e,n),"id"==s?d(o).data("new-id",e[s]):o.setAttribute(s,e[s])},t.prototype.addChange=function(t,e,a,i){var n=this;switch(t){case"create":n.changes.push({action:"create",data:e});break;case"update":var o=n.changes[n.changes.length-1],s=Object.keys(a)[0],p=(new Date).getTime();p-n.lastChangeTime<500&&o&&"update"==o.action&&o.id==n.getObjectId(e)&&o.dataNew[s]?n.changes[n.changes.length-1].dataNew[s]=a[s]:n.changes.push({action:"update",data:e,idReal:e.id,id:n.getObjectId(e),dataOld:i,dataNew:a}),n.lastChangeTime=p;break;case"delete":n.changes.push({action:"delete",data:e})}n.changed=!0},t.prototype.addUpdateChange=function(t,e,a){},t.prototype.getObjectId=function(t){return d(t).data("new-id")?d(t).data("new-id"):d(t).data("id")?d(t).data("id"):t.id},t.prototype.saveSvg=function(){var a=this;d("#mapsvg-save-svg")._button("loading");d.get(a.filepath+"?v="+Math.random()).done(function(t){a.changes.length&&a.changes.forEach(function(t){switch(t.action){case"update":for(var e in t.dataNew)"id"==e&&t.data.setAttribute(e,t.dataNew[e])}}),a.editingShape&&(a.editingShape.unclosed?a.removeShape(a.editingShape.obj):a.editingShapeUnset()),a.controllers.region&&(a.admin.unloadController(a.controllers.region),a.controllers.region=null);var e=a.svg.clone(!0);e.css("transform",""),e.find("[data-deleted]").remove(),e.find("path, polygon, circle, ellipse, rect").each(function(t){d(this).data("stroke-width")&&d(this).css("stroke-width",d(this).data("stroke-width")),d(this).attr("class")&&(d(this).attr("class",d(this).attr("class").replace("active","")),d(this).attr("class",d(this).attr("class").replace("mapsvg-custom-shape","")),d(this).attr("class",d(this).attr("class").replace("mapsvg-region","")),d(this).attr("class",d(this).attr("class").replace("mapsvg-disabled","")))}),d.post(ajaxurl,{action:"mapsvg_save_svg",map_id:a.mapsvg.id,body:e[0].outerHTML.replace(/\sgeoViewBox/gi," mapsvg:geoViewBox"),filepath:a.filepath}).done(function(t){e=null,a.changed=!1,a.changes=[],a.mapsvg.regionsDatabase.getAll().done(function(){a.mapsvg.reloadRegions(),a.mapsvg.reloadRegionsFull()})}).fail(function(t){}).always(function(){d("#mapsvg-save-svg")._button("reset")})})},t.prototype.close=function(){},t.prototype.undo=function(){var t=this;if(!t.changes.length)return!1;var e=t.changes.pop();switch(e.action){case"create":t.editingShape&&t.editingShape.obj===e.data&&t.editingShapeUnset(),e.data.remove();break;case"delete":e.data.style.display="block",e.data.setAttribute("id",e.data.getAttribute("data-id")),e.data.setAttribute("data-id",""),e.data.removeAttribute("data-deleted");break;case"update":t.updateShape(e.idReal,e.dataOld,!0),!t.isReverting&&t.editingShape&&t.editingShape.obj.id==e.idReal&&t.editShape(t.editingShape.obj)}return!0},t.prototype.revert=function(){var t=!0;for(this.isReverting=!0;t;)t=this.undo()},t.prototype.removeEditingPoint=function(t){var e=this;e.editingShape.pathData.splice(e.editingPoint.index,1),2==e.editingShape.pathData.length?e.removeShape(e.editingShape.obj):("M"!=e.editingShape.pathData[0].type&&(e.editingShape.pathData[0].type="M"),e.editingShape.points.splice(e.editingPoint.index,1),e.editingShape.obj.setPathData(e.editingShape.pathData),d(e.editingPoint.circle).remove(),e.editingPoint=null,e.editingShape.points.forEach(function(t,e){d(t).data("index",e)})),this.hint()},t.prototype.removeShape=function(t){var e=this;if(t){var a=e.editingShape&&e.editingShape.obj==t;(!e.editingShape||a&&!e.editingShape.unclosed)&&e.addChange("delete",t),a&&(e.editingShape.obj.style.display="none",e.editingShape.obj.setAttribute("data-id",e.editingShape.obj.id),e.editingShape.obj.setAttribute("id",""),e.editingShape.obj.setAttribute("data-deleted","true"),e.editingShape.points&&e.editingShape.points.forEach(function(t){t.remove()}),e.editingShape.stroke&&d(e.editingShape.stroke).remove(),e.editingShape=null,e.controllers.region&&(e.admin.unloadController(e.controllers.region),e.controllers.region=null),e.setEventHandlers())}},t.prototype.doSnap=function(t){for(var e,a=this,i=!0,n=10/a.mapsvg.getScale(),o=a.snapPoints.length-1;i&&0<=o;)a.snapPoints[o]&&a.snapPoints[o].values&&null!=a.snapPoints[o].values[0]&&(e=a.snapPoints[o],Math.abs(t[0]-e.values[0])<n&&Math.abs(t[1]-e.values[1])<n&&(t[0]=e.values[0],t[1]=e.values[1],i=!1)),o--;return t},t.prototype.loadSnapPoints=function(){var a=this;this.snapPoints=[],a.svg.find("path, polygon, rect, circle, ellipse, polyline").not(":hidden").not(".mapsvg-path-point").each(function(t,e){a.editingShape&&e===a.editingShape.obj||"none"!=d(e).css("display")&&(a.snapPoints=a.snapPoints.concat(e.getPathData({normalize:!0})))})},t.prototype.loadIntersectionPoints=function(){var t=this;t.editingShape.pathLength=t.editingShape.obj.getTotalLength(),t.editingShape.pathPoints=[];for(var e=0;e<t.editingShape.pathLength;e++)t.editingShape.pathPoints.push(t.editingShape.obj.getPointAtLength(e))},t.prototype.getIntersectionWithEditingShape=function(t){for(var e=0;e<this.editingShape.pathPoints.length;e++)if(this.pointIntersect(t,this.editingShape.pathPoints[e]))return this.editingShape.pathPoints[e+1]},t.prototype.getPreviousPointIndex=function(t){for(var e=!0,a=0,i=1,n=1;e;){var o=this.editingShape.pathPoints[a];if(o.x==t.x&&o.y==t.y)e=!1;else{var s=this.editingShape.points[n];(s={x:s.getAttribute("cx"),y:s.getAttribute("cy")}).x==o.x&&s.y==o.y&&(i=n,n++)}a++}return i},t.prototype.pointIntersect=function(t,e){var a=5/this.mapsvg.getScale();return Math.abs(t.x-e.x)<a&&Math.abs(t.y-e.y)<a},t.prototype.addNewPoint=function(t,e){var a=this,i={x:parseFloat(t),y:parseFloat(e)},n=1;a.editingShape.pathData=a.editingShape.obj.getPathData({normalize:!0});for(var o=1;o<a.editingShape.pathData.length;o++){var s=o-1,p=o,d=a.editingShape.pathData[s],r=a.editingShape.pathData[p];d.values&&("Z"!=r.type&&"z"!=r.type||(r=a.editingShape.pathData[0]),d={x:d.values[0],y:d.values[1]},r={x:r.values[0],y:r.values[1]},0==a.distanceToLine(d,r,i)&&(n=o))}var g={type:"L",values:[t,e]};return a.editingShape.pathData.splice(n,0,g),a.editingShape.d=a.editingShape.obj.getAttribute("d"),a.editingShape.obj.setPathData(a.editingShape.pathData),a.addChange("update",a.editingShape.obj,{d:a.editingShape.obj.getAttribute("d")},{d:a.editingShape.d}),a.editShape(a.editingShape.obj),n},t.prototype.isOnLine=function(t,e,a){var i;return Math.abs((i=a.px,(e.y-t.y)/(e.x-t.x)*(i-t.x)+t.y-a.py))<.001},t.prototype.distanceToLine=function(t,e,a){var i=(e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y);if(0==i)return!1;var n=((t.y-a.y)*(e.x-t.x)-(t.x-a.x)*(e.y-t.y))/i;return(Math.abs(n)*Math.sqrt(i)).toFixed(3)}}(jQuery,window);
!function(n,t){var e=function(t,e,r){this.name="filters",this.scrollable=!1,this.isParent=!0,MapSVGAdminController.call(this,t,e,r)};t.MapSVGAdminFiltersController=e,MapSVG.extend(e,t.MapSVGAdminController),e.prototype.viewLoaded=function(){var t=this;this.controllers.structure=new MapSVGAdminFiltersStructureController("mapsvg-filters-structure",t.admin,t.mapsvg),this.controllers.settings=new MapSVGAdminFiltersSettingsController("mapsvg-filters-settings",t.admin,t.mapsvg),t.activeController=this.controllers.settings,MapSVGAdminController.prototype.viewLoaded.call(this)},e.prototype.viewDidAppear=function(){var t=this;t.activeController&&t.activeController instanceof MapSVGAdminFiltersStructureController&&(t.admin.rememberPanelsState(),t.admin.togglePanel("left",!1))},e.prototype.viewDidDisappear=function(){this.admin.restorePanelsState()},e.prototype.setEventHandlers=function(){var i=this;n("#mapsvg-filters-menu a").click(function(t){t.preventDefault(),n(this).tab("show")}).on("shown.bs.tab",function(t){var e=n(n(this).attr("href")).data("controller");(i.activeController=e).viewDidAppear();var r=n(t.relatedTarget).attr("href");if(r){var a=n(r).attr("data-controller");i.controllers[a].viewDidDisappear()}"#mapsvg-filters-structure"==n(this).attr("href")?(i.admin.rememberPanelsState(),i.admin.togglePanel("left",!1)):i.admin.restorePanelsState(),"#mapsvg-filters-settings"==n(this).attr("href")&&n(".mapsvg-toolbar-buttons").show()})}}(jQuery,window);
!function(t,n){var e=function(t,n,e){this.name="filters-settings",MapSVGAdminController.call(this,t,n,e)};n.MapSVGAdminFiltersSettingsController=e,MapSVG.extend(e,n.MapSVGAdminController),e.prototype.viewLoaded=function(){},e.prototype.setEventHandlers=function(){}}(jQuery,window);
!function(i,e){var t=function(e,t,i,s){this.name="filters-structure",this.scrollable=!1,MapSVGAdminController.call(this,e,t,i),this.filtersSchema=this.mapsvg.filtersSchema};e.MapSVGAdminFiltersStructureController=t,MapSVG.extend(t,e.MapSVGAdminController),t.prototype.viewLoaded=function(){},t.prototype.viewDidAppear=function(){var t=this;t.formBuilder=new MapSVG.FormBuilder({schema:t.filtersSchema.getSchema(),editMode:!0,filtersMode:!0,mapsvg:t.mapsvg,admin:t.admin,container:this.contentView,template:"form-builder-filters",types:["select","distance","search"],events:{saveSchema:function(e){t.mapsvg.id?(t.filtersSchema.setSchema(e),i.growl.notice({title:"",message:"Settings saved"}),t.admin.save(),t.mapsvg.setFilters()):t.admin.save().done(function(){t.filtersSchema.setSchema(e),t.mapsvg.setFilters()})},load:function(){setTimeout(function(){i("#mapsvg-btn-filters-structure").tooltip("show").tooltip("hide")},200)}}})},t.prototype.viewDidDisappear=function(){MapSVGAdminController.prototype.viewDidDisappear.call(this),this.formBuilder&&this.formBuilder.destroy()},t.prototype.setEventHandlers=function(){}}(jQuery,window);
!function(o,t){var i=function(o,t,i){this.name="floors",this.scrollable=!1,this.isParent=!0,MapSVGAdminController.call(this,o,t,i)};t.MapSVGAdminFloorsController=i,MapSVG.extend(i,t.MapSVGAdminController),i.prototype.viewLoaded=function(){var o=this;this.controllers.list=new MapSVGAdminFloorsListController("mapsvg-floors-list",o.admin,o.mapsvg),this.controllers.list.toolbarView=this.toolbarView,o.activeController=this.controllers.list,MapSVGAdminController.prototype.viewLoaded.call(this)},i.prototype.viewDidAppear=function(){MapSVGAdminController.prototype.viewDidAppear.call(this)},i.prototype.viewDidDisappear=function(){MapSVGAdminController.prototype.viewDidDisappear.call(this)},i.prototype.setEventHandlers=function(){}}(jQuery,window);
!function(l,e){var t=function(e,t,a){this.name="floors-list",this.database=new MapSVG.DatabaseService({type:"local",dbObject:a.getData().options.floors},a),this.database.on("change",function(){}),this.database.setSchema([{name:"id",label:"ID",visible:!0,type:"id"},{name:"object_id",label:"Object ID",visible:!0,type:"select",optionsGrouped:!0,options:a.getGroupSelectOptions()},{name:"title",label:"Title",visible:!0,type:"text"},{name:"visible",label:"Visible",visible:!1,type:"checkbox"}]),MapSVGAdminController.call(this,e,t,a)};e.MapSVGAdminFloorsListController=t,MapSVG.extend(t,e.MapSVGAdminController),t.prototype.viewLoaded=function(){this.redrawDataList()},t.prototype.viewDidAppear=function(){MapSVGAdminController.prototype.viewDidAppear.call(this)},t.prototype.viewDidDisappear=function(){MapSVGAdminController.prototype.viewDidDisappear.call(this),this.closeFormHandler()},t.prototype.setEventHandlers=function(){var o=this;l("#mapsvg-btn-floor-add").on("click",function(e){e.preventDefault(),o.btnAdd=l(this),o.btnAdd.addClass("disabled"),o.editDataRow()}),this.view.on("click",".mapsvg-data-row",function(e){l(this).hasClass("active")||o.editDataRow(l(this))}).on("click",".mapsvg-floor-view-toggle",function(e){e.preventDefault(),e.stopPropagation(),l(this).toggleClass("active");var t=l(this).closest("tr").data("id"),a=o.database.getLoadedObject(t);a.visible=!l(this).hasClass("active"),a.visible?(l(this).find("i").toggleClass("fa-eye",!0),l(this).find("i").toggleClass("fa-eye-slash",!1)):(l(this).find("i").toggleClass("fa-eye",!1),l(this).find("i").toggleClass("fa-eye-slash",!0)),o.mapsvg.setGroups(),o.mapsvg.setFloorsControl()}).on("click",".mapsvg-floor-delete",function(e){e.preventDefault(),e.stopPropagation();var t=l(this).closest("tr");o.deleteDataRow(t)})},t.prototype.getTemplateData=function(){return{fields:this.getDataFieldsForTemplate(!0),data:this.database.getLoaded()}},t.prototype.getDataFieldsForTemplate=function(e){return[{name:"id",visible:!0,type:"id"},{name:"object_id",visible:!0,type:"select"},{name:"title",visible:!0,type:"text"}]},t.prototype.redrawDataList=function(){var e=this;e.redraw();var t=this.mapsvg.getPagination(function(){e.redrawDataList()});this.view.find(".mapsvg-pagination-container").html(t)},t.prototype.getObjectRow=function(e){return this.view.find("#mapsvg-floor-row-"+e.id)},t.prototype.addDataRow=function(e){var t={fields:this.database.getColumns({visible:!0}),params:e},a=l(this.templates.item(t));return this.view.find("#mapsvg-floors-list-table tbody").prepend(a),a},t.prototype.updateDataRow=function(e,t){var a={fields:this.database.getColumns({visible:!0}),params:e},o=l(this.templates.item(a));(t=t||l("#mapsvg-floor-row-"+e.id)).replaceWith(o),o.addClass("mapsvg-row-updated"),setTimeout(function(){o.removeClass("mapsvg-row-updated")},2600)},t.prototype.deleteDataRow=function(e){var t=e.data("id"),a=this.database.getLoadedObject(t);if(!a)return!1;a.marker&&this.mapsvg.markerDelete(a.marker),this.database.delete(t),e.fadeOut(300,function(){e.remove()})},t.prototype.editDataRow=function(e,t){var a=this,o=!e,i={};if(a.tableDataActiveRow&&a.tableDataActiveRow.removeClass("mapsvg-row-selected"),e){a.updateScroll(),t&&a.contentWrap.data("jsp").scrollToElement(e,!0,!1),a.tableDataActiveRow=e,a.tableDataActiveRow.addClass("mapsvg-row-selected");var s=a.tableDataActiveRow.data("id");i=a.database.getLoadedObject(s)}else i={visible:!0};var r=wp.media.frames.file_frame=wp.media({title:"Choose images",button:{text:"Choose images"},multiple:!0});a.formBuilder&&(a.formBuilder.destroy(),a.formBuilder=null,a.formBuilderRow&&a.formBuilderRow.remove(),l("#mapsvg-btn-floor-add").removeClass("disabled")),a.formContainer&&a.formContainer.empty().remove(),a.formContainer=l('<div class="mapsvg-modal-edit"></div>'),this.view.append(a.formContainer),a.formBuilder=new MapSVG.FormBuilder({container:a.formContainer,schema:a.database.getSchema(),editMode:!1,mapsvg:a.mapsvg,mediaUploader:r,data:i,admin:a.admin,events:{save:function(e){o?(a.saveDataObject(e),this.redraw()):(a.updateDataObject(e),this.close())},close:function(){a.closeFormHandler()}}})},t.prototype.saveDataObject=function(e){var t,a,o=this;if(e.id&&(t=this.getObjectRow(e)),t&&t.length||(a=!0,t=this.addDataRow(e)),a)this.database.create(e).done(function(e){a&&o.updateDataRow(e,t)}).fail(function(){l.growl.error({title:"Server error",message:"Can't save object"}),t.remove()});else{if(this.database.update(e).fail(function(){l.growl.error({title:"Server error",message:"Can't update object"})}),e.marker){var i=o.mapsvg.getMarker(e.marker.id);i.setId("marker_"+e.id),i.setObject(e)}this.closeFormHandler(),this.updateDataRow(e)}},t.prototype.updateDataObject=function(e){if(this.database.update(e).fail(function(){l.growl.error({title:"Server error",message:"Can't update object"})}),e.marker){var t=this.mapsvg.getMarker(e.marker.id);t.setId("marker_"+e.id),t.setObject(e)}this.closeFormHandler(),this.updateDataRow(e)},t.prototype.closeFormHandler=function(){var e=this;l("#mapsvg-btn-floor-add").removeClass("disabled"),e.mapsvg.showMarkers(),e.formBuilder&&(e.formBuilder.destroy(),e.formBuilder=null,e.formContainer.empty().remove(),e.tableDataActiveRow&&e.tableDataActiveRow.removeClass("mapsvg-row-selected"),e.tableDataActiveRow&&!e.tableDataActiveRow.hasClass("mapsvg-row-updated")&&e.tableDataActiveRow.addClass("mapsvg-row-closed"),setTimeout(function(){e.tableDataActiveRow&&!e.tableDataActiveRow.hasClass("mapsvg-row-updated")&&e.tableDataActiveRow.removeClass("mapsvg-row-closed")},1600),l("a.browser").remove()),this.updateScroll()}}(jQuery,window);
var scripts=document.getElementsByTagName("script"),myScript=scripts[scripts.length-1].src.split("/");myScript.pop();var pluginRootURL=myScript.join("/")+"/";!function(c,d,e){function a(e,t){e=e||{};var i=this;if(this.formBuilder=t,this.images=[],this.type=e.type,this.value=e.value,this.searchable=d.parseBoolean(e.searchable),this.databaseFields=this.formBuilder.mapsvg.database.getSchema().map(function(e){if("text"==e.type||"region"==e.type||"textarea"==e.type||"post"==e.type||"select"==e.type||"radio"==e.type||"checkbox"==e.type)return"post"==e.type?"Object.post.post_title":"Object."+e.name}),this.regionFields=this.formBuilder.mapsvg.regionsDatabase.getSchema().map(function(e){if("status"==e.type||"text"==e.type||"textarea"==e.type||"post"==e.type||"select"==e.type||"radio"==e.type||"checkbox"==e.type)return"Region."+e.name}),this.db_type="varchar(255)","region"==this.type)this.options=this.formBuilder.getRegionsList(),this.label="Regions",this.name="regions",this.db_type="text";else if("textarea"==this.type)this.autobr=e.autobr,this.html=e.html,this.db_type="text";else if("modal"==this.type)this.buttonText=e.buttonText;else if("location"==this.type)this.location=this.value,this.db_type="text";else if("search"==this.type)this.fallback=d.parseBoolean(e.fallback),this.placeholder=e.placeholder||"Search",this.noResultsText=e.noResultsText||"No results found",this.width=i.formBuilder.filtersHide&&!i.formBuilder.modal?null:e.width||"100%";else if("distance"==this.type){this.label=e.label||"Search radius",this.distanceControl=e.distanceControl||"select",this.distanceUnits=e.distanceUnits||"km",this.distanceUnitsLabel=e.distanceUnitsLabel||"km",this.fromLabel=e.fromLabel||"from",this.placeholder=e.placeholder,this.userLocationButton=e.userLocationButton||!1,this.type=e.type,this.addressField=e.addressField||!0,this.addressFieldPlaceholder=e.addressFieldPlaceholder||"Address",this.options=e.options||[{value:"10",default:!0},{value:"30",default:!1},{value:"50",default:!1},{value:"100",default:!1}];var a=!1;i.value&&this.options.forEach(function(e){e.value===i.value.length&&(e.selected=!0,a=!0)}),a||this.options.forEach(function(e){e.default&&(e.selected=!0)})}else"post"==this.type?(i.formBuilder.admin&&(this.post_types=this.formBuilder.admin.getPostTypes()),this.post_type=e.post_type||this.post_types[0],this.add_fields=d.parseBoolean(e.add_fields),this.db_type="int(11)",this.name="post_id",this.post_id=e.post_id,this.post=e.post):"checkbox"==this.type?(this.db_type="tinyint(1)",this.checkboxLabel=e.checkboxLabel,this.checkboxValue=e.checkboxValue):"radio"==this.type||"select"==this.type?(this.options=e.options||[{label:"Option one",name:"option_one",value:1},{label:"Option two",name:"option_two",value:2}],"select"==this.type&&(this.multiselect=e.multiselect,this.optionsGrouped=e.optionsGrouped,this.db_type=this.multiselect?"text":"varchar(255)"),this.optionsDict=e.optionsDict||{},this.optionsDict||this.options.forEach(function(e){i.optionsDict[e.value]=e.label})):"image"==this.type?(this.button_text=e.button_text||"Browse...",this.db_type="text",this.label=e.label||"Images",this.name=e.name||"images"):"status"==this.type?(this.label=e.label||"Status",this.name="status",this.options=e.options||[{label:"Enabled",value:1,color:"",disabled:!1},{label:"Disabled",value:0,color:"",disabled:!0}]):"date"==this.type&&(i.formBuilder.admin&&(this.languages=["en-GB","ar","az","bg","bs","ca","cs","cy","da","de","el","es","et","eu","fa","fi","fo","fr","gl","he","hr","hu","hy","id","is","it","ja","ka","kh","kk","kr","lt","lv","mk","ms","nb","nl","nl-BE","no","pl","pt-BR","pt","ro","rs","rs-latin","ru","sk","sl","sq","sr","sr-latin","sv","sw","th","tr","uk","vi","zh-CN","zh-TW"]),this.db_type="varchar(50)",this.language=e.language);this.label=this.label||(void 0===e.label?"Label":e.label),this.name=this.name||e.name||"label",this.help=e.help||"",this.placeholder=e.placeholder;var s=this.type;if("marker"===s&&i.formBuilder.mapsvg.isGeo()&&(s="marker-geo"),"location"===s&&i.formBuilder.mapsvg.isGeo()&&(s="location-geo"),this.formBuilder.filtersMode?(this.parameterName=e.parameterName||"",this.parameterNameShort=this.parameterName.split(".")[1],this.placeholder=e.placeholder||"Any",this.templates={result:Handlebars.compile(c("#mapsvg-filters-tmpl-"+s+"-view").html())}):this.templates={result:Handlebars.compile(c("#mapsvg-data-tmpl-"+s+"-view").html())},this.views={result:c(this.templates.result(this.get()))},this.views.result.data("formElement",this),c().mselect2&&("distance"!==this.type?this.views.result.find("select").css({width:"100%",display:"block"}).mselect2().on("select2:focus",function(){c(this).mselect2("open")}):this.views.result.find("select").mselect2().on("select2:focus",function(){c(this).mselect2("open")})),this.html){var r=this.views.result.find("textarea")[0];this.editor=CodeMirror.fromTextArea(r,{mode:{name:"handlebars",base:"text/html"},matchBrackets:!0,lineNumbers:!0}),i.formBuilder.admin&&this.editor.on("change",this.setTextareaValue)}"image"==this.type&&(this.images=this.value||[],this.redrawImages()),"marker"!=this.type&&"location"!=this.type||(this.templates.marker=Handlebars.compile(c("#mapsvg-data-tmpl-marker").html()),this.location&&this.location.marker&&i.renderMarker()),this.setEventHandlers()}d.parseBoolean=function(e){switch(String(e).toLowerCase()){case"on":case"true":case"1":case"yes":case"y":return!0;case"off":case"false":case"0":case"no":case"n":return!1;default:return}},a.prototype.setTextareaValue=function(e,t){var i=e.getValue();c(e.getTextArea()).val(i).trigger("change")},a.prototype.setEventHandlers=function(){var n=this;if(this.formBuilder.editMode)this.views.result.on("click",function(){n.formBuilder.edit(n)});else{if("image"==this.type){var e=n.views.result.find(".mapsvg-data-images");this.formBuilder.mediaUploader.on("select",function(){if(n.formBuilder.mediaUploaderFor!==n)return!1;n.formBuilder.mediaUploader.state().get("selection").toJSON().forEach(function(e){var t={sizes:{}};for(var i in e.sizes)t[i]=e.sizes[i].url.replace("http://","//").replace("https://","//"),t.sizes[i]={width:e.sizes[i].width,height:e.sizes[i].height};t.thumbnail||(t.thumbnail=t.full,t.sizes.thumbnail={width:e.sizes.full.width,height:e.sizes.full.height}),t.medium||(t.medium=t.full,t.sizes.medium={width:e.sizes.full.width,height:e.sizes.full.height}),n.images.push(t)}),n.redrawImages()}),n.views.result.on("click",".mapsvg-upload-image",function(e){e.preventDefault(),(n.formBuilder.mediaUploaderFor=n).formBuilder.mediaUploader.open()}),n.views.result.on("click",".mapsvg-image-delete",function(e){e.preventDefault(),c(this).closest(".mapsvg-thumbnail-wrap").remove(),n.images=[],n.views.result.find("img").each(function(e,t){n.images.push(c(t).data("image"))}),n.views.result.find("input").val(JSON.stringify(n.images))}),n.sortable=new Sortable(e[0],{animation:150,onStart:function(){n.elements.containers.form_view.addClass("sorting")},onEnd:function(e){n.images=[],n.views.result.find("img").each(function(e,t){n.images.push(c(t).data("image"))}),n.views.result.find("input").val(JSON.stringify(n.images))}})}if("post"==this.type){n.views.result.find(".mapsvg-find-post").mselect2({ajax:{url:ajaxurl+"?action=mapsvg_search_posts&post_type="+n.post_type,dataType:"json",delay:250,data:function(e){return{query:e.term,page:e.page}},processResults:function(e,t){return t.page=t.page||1,{results:e,pagination:{more:!1}}},cache:!0},escapeMarkup:function(e){return e},minimumInputLength:1,templateResult:function(e){return e.loading?e.text:"<div class='select2-result-repository clearfix'>"+e.post_title+"</div>"},templateSelection:function(e){return e.post_title||e.text}}).on("select2:select",function(e){n.post=e.params.data,n.views.result.find(".mapsvg-post-id").text(n.post.ID),n.views.result.find(".mapsvg-post-url").text(n.post.url).attr("href",n.post.url),n.views.result.find('input[name="post_id"]').val(n.post.ID)})}if("location"===this.type){if(n.formBuilder.mapsvg.isGeo()){var t=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.whitespace("formatted_address"),queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:ajaxurl+"?action=mapsvg_geocoding&address=%QUERY%",wildcard:"%QUERY%",transform:function(e){return e.error_message&&alert(e.error_message),e.results},rateLimitWait:600}});(l=this.views.result.find(".typeahead")).typeahead({minLength:3},{name:"mapsvg-addresses",display:"formatted_address",source:t});l.on("typeahead:select",function(e,t){n.location&&n.location.marker&&n.deleteMarker();var i={};i.formatted=t.formatted_address,t.address_components.forEach(function(e){var t=e.types[0];i[t]=e.long_name,e.short_name!=e.long_name&&(i[t+"_short"]=e.short_name)});var a={address:i,lat:t.geometry.location.lat,lng:t.geometry.location.lng};n.location=new d.Location(a),n.formBuilder.location=this.location;var s=new d.Marker({location:n.location,mapsvg:n.formBuilder.mapsvg});n.location.marker=s,n.formBuilder.mapsvg.setEditingMarker(s.id),n.formBuilder.marker=s.getOptions(),n.renderMarker();var r=n.formBuilder.view.find('select[name="regions"]');if(-1!==n.formBuilder.mapsvg.getData().options.source.indexOf("/geo-calibrated/usa.svg"))0!==r.length&&n.location.address.state_short&&(r.val(["US-"+n.location.address.state_short]),r.trigger("change"));else if(-1!==n.formBuilder.mapsvg.getData().options.source.indexOf("/geo-calibrated/world.svg"))0!==r.length&&n.location.address.country_short&&(r.val([n.location.address.country_short]),r.trigger("change"));else if(0!==r.length&&n.location.address.administrative_area_level_1){var o=n.formBuilder.mapsvg.getData().regions.filter(function(e){return e.title===n.location.address.administrative_area_level_1||e.title===n.location.address.administrative_area_level_2||e.id===n.location.address.country_short+"-"+n.location.address.administrative_area_level_1_short});0<o.length&&(o=o[0],r.val([o.id]),r.trigger("change"))}l.typeahead("val","")})}n.views.result.on("click",".mapsvg-marker-image-btn-trigger",function(e){c(this).toggleClass("active"),n.toggleMarkerSelector.call(n,c(this),e)}),n.views.result.on("click",".mapsvg-marker-delete",function(e){e.preventDefault(),n.deleteMarker()})}if("distance"===this.type){if(n.formBuilder.mapsvg.isGeo()){var l;t=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.whitespace("formatted_address"),queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:ajaxurl+"?action=mapsvg_geocoding&address=%QUERY%",wildcard:"%QUERY%",transform:function(e){return e.error_message&&alert(e.error_message),e.results},rateLimitWait:600}}),(l=this.views.result.find(".typeahead")).typeahead({minLength:3},{name:"mapsvg-addresses",display:"formatted_address",source:t,limit:5});l.on("change keyup",function(){""===c(this).val()&&n.formBuilder.view.find('[name="distanceLatLng"]').val("").trigger("change")}),l.on("typeahead:select",function(e,t){t.formatted_address;var i=t.geometry.location;n.formBuilder.view.find('[name="distanceLatLng"]').val(i.lat+","+i.lng).trigger("change"),l.blur()})}n.views.result.on("click",".mapsvg-marker-image-btn-trigger",function(e){c(this).toggleClass("active"),n.toggleMarkerSelector.call(n,c(this),e)}),n.views.result.on("click",".mapsvg-marker-delete",function(e){e.preventDefault(),n.deleteMarker()})}}},a.prototype.toggleMarkerSelector=function(e,t){t.preventDefault();var i=this;if(i.markerSelector&&i.markerSelector.is(":visible"))i.markerSelector.hide();else if(i.markerSelector&&i.markerSelector.not(":visible"))i.markerSelector.show();else{i.markerImageButton=e.find("img");var a=i.markerImageButton.attr("src"),s=d.markerImages.map(function(e){return'<button class="btn btn-default mapsvg-marker-image-btn mapsvg-marker-image-btn-choose '+(a==e.url?"active":"")+'"><img src="'+e.url+'" /></button>'});i.markerSelector||(i.markerSelector=i.views.result.find(".mapsvg-marker-image-selector")),i.markerSelector&&i.markerSelector.empty(),i.formBuilder.markerSelector=i.markerSelector,i.formBuilder.marker?i.markerSelector.data("marker",i.formBuilder.marker):i.markerSelector.data("marker",null),i.markerSelector.html(s.join("")),i.markerSelector.on("click",".mapsvg-marker-image-btn-choose",function(e){e.preventDefault();var t=c(this).find("img").attr("src");i.formBuilder.marker&&i.formBuilder.mapsvg.getMarker(i.formBuilder.marker.id).setImage(t);i.markerSelector.hide(),i.views.result.find(".mapsvg-marker-image-btn-trigger").toggleClass("active",!1),i.markerImageButton.attr("src",t),d.defaultMarkerImage=t})}},a.prototype.deleteMarker=function(){this.formBuilder.marker&&(this.formBuilder.mapsvg.getMarker(this.formBuilder.marker.id).delete(),delete this.formBuilder.marker),this.views.result.find(".mapsvg-new-marker").hide(),this.views.result.find(".mapsvg-marker-id").attr("disabled","disabled")},a.prototype.renderMarker=function(e){var t=this;if(!this.location&&!e.location)return!1;e&&e.location&&(this.location=e.location),t.views.result.find(".mapsvg-new-marker").show().html(this.templates.marker(this.location)),this.location.marker.onChange=function(){t.renderMarker()}},a.prototype.redrawImages=function(){var a=this.views.result.find(".mapsvg-data-images");a.empty(),this.images&&this.images.forEach(function(e){var t=c('<img class="mapsvg-data-thumbnail" />').attr("src",e.thumbnail).data("image",e),i=c('<div class="mapsvg-thumbnail-wrap"></div>').data("image",e);i.append(t),i.append('<i class="fa fa-times  mapsvg-image-delete"></i>'),a.append(i)}),this.views.result.find("input").val(JSON.stringify(this.images))},a.prototype.setEditorEventHandlers=function(){var o=this;this.views.edit.on("click","button.mapsvg-remove",function(){o.views.result.empty().remove(),o.views.edit.empty().remove(),o.formBuilder.delete(o)}).on("keyup change paste",".mapsvg-edit-status-row input",function(){o.mayBeAddStatusRow()}).on("keyup change paste",".mapsvg-edit-distance-row input",function(){o.mayBeAddDistanceRow()}),this.views.edit.on("click",".mapsvg-filter-insert-options",function(){var e,t,i=o.parameterName.split(".")[0],a=o.parameterName.split(".")[1];(e="Object"==i?o.formBuilder.mapsvg.database.getSchemaField(a):"id"==a?{options:o.formBuilder.mapsvg.getData().regions.map(function(e){return{label:e.id,value:e.id}})}:"region_title"==a?{options:o.formBuilder.mapsvg.getData().regions.map(function(e){return{label:e.title,value:e.title}})}:o.formBuilder.mapsvg.regionsDatabase.getSchemaField(a))&&e.options&&(t="regions"==a?(e.options[0].title&&e.options[0].title.length&&e.options.sort(function(e,t){return e.title<t.title?-1:e.title>t.title?1:0}),e.options.map(function(e){return(e.title||e.id)+":"+e.id})):e.options.map(function(e){return e.label+":"+e.value}),c(this).closest(".form-group").find("textarea").val(t.join("\n")).trigger("change"))}),this.views.edit.on("keyup change paste","input, textarea, select",function(){var e=c(this).attr("name"),t=c(this).data("array");if("status"===o.type&&t){var i=c(this).data("param"),a=c(this).closest("tr").index();o.options[a]=o.options[a]||{label:"",value:"",color:"",disabled:!1},o.options[a][i]=c(this).is(":checkbox")?c(this).prop("checked"):c(this).val(),o.redraw()}else if("distance"===o.type&&t){i=c(this).data("param"),a=c(this).closest("tr").index();o.options[a]||(o.options[a]={value:"",default:!1}),"default"===i?(o.options.forEach(function(e,t){e.default=!1}),o.options[a].default=c(this).prop("checked")):o.options[a].value=c(this).val(),o.redraw()}else{if("label"==e||"name"==e)return!1;var s;if(s="checkbox"==c(this).attr("type")?c(this).prop("checked"):c(this).val(),"radio"==c(this).attr("type")){var r=c(this).attr("name");s=c('input[name="'+r+'"]:checked').val()}o.update(e,s)}}),this.views.edit.on("keyup change paste",'input[name="label"]',function(){if(!o.nameChanged){var e=c(this).val();e=e.toLowerCase().replace(/ /g,"_").replace(/\W/g,""),o.views.edit.find('input[name="name"]').val(e),o.label=c(this).val(),"region"!=o.type&&(o.name=e),o.views.result.find("label").first().html(o.label),o.formBuilder.filtersMode||o.views.result.find("label").first().append('<div class="field-name">'+o.name+"</div>")}}),this.views.edit.on("keyup change paste",'input[name="name"]',function(){this.value&&(this.value.match(/[^a-zA-Z0-9_]/g)&&(this.value=this.value.replace(/[^a-zA-Z0-9_]/g,""),c(this).trigger("change")),this.value[0].match(/[^a-zA-Z_]/g)&&(this.value=this.value[0].replace(/[^a-zA-Z_]/g,"")+this.value.slice(1),c(this).trigger("change"))),"region"!=o.type&&(o.name=this.value),o.views.result.find("label").html(o.label+'<div class="field-name">'+o.name+"</div>"),o.nameChanged=!0})},a.prototype.getEditor=function(){return this.formBuilder.filtersMode?this.templates.edit=this.templates.edit||Handlebars.compile(c("#mapsvg-filters-tmpl-"+this.type+"-control").html()):this.templates.edit=this.templates.edit||Handlebars.compile(c("#mapsvg-data-tmpl-"+this.type+"-control").html()),this.views.edit=c(this.templates.edit(this.get())),this.views.edit},a.prototype.destroyEditor=function(){this.views.edit.empty().remove()},a.prototype.initEditor=function(){var a=this;this.views.edit.find("input").first().select(),c().mselect2&&("distance"!==this.type?this.views.edit.find("select").css({width:"100%",display:"block"}).mselect2():this.views.edit.find("select").mselect2()),"status"==this.type&&(a.views.edit.find(".cpicker").colorpicker().on("changeColor.colorpicker",function(e){var t=c(this).find("input"),i=c(this).closest("tr").index();""==t.val()&&c(this).find("i").css({"background-color":""}),a.options[i]=a.options[i]||{label:"",value:"",color:"",disabled:!1},a.options[i].color=t.val()}),a.mayBeAddStatusRow()),"distance"===this.type&&a.mayBeAddDistanceRow(),this.views.edit.find(".mapsvg-onoff").bootstrapToggle({onstyle:"default",offstyle:"default"}),this.setEditorEventHandlers()},a.prototype.mayBeAddStatusRow=function(){var a=this;this.templates.editStatusRow=this.templates.editStatusRow||c(c("#mapsvg-edit-status-row").html());var e=a.views.edit.find(".mapsvg-edit-status-label:last-child");if(e&&e.last()&&e.last().val()&&e.last().val().trim().length){var t=this.templates.editStatusRow.clone();t.insertAfter(a.views.edit.find(".mapsvg-edit-status-row:last-child")),t.find(".cpicker").colorpicker().on("changeColor.colorpicker",function(e){var t=c(this).find("input"),i=c(this).closest("tr").index();""==t.val()&&c(this).find("i").css({"background-color":""}),a.options[i]=a.options[i]||{label:"",value:"",color:"",disabled:!1},a.options[i].color=t.val()})}var i=a.views.edit.find(".mapsvg-edit-status-row"),s=i.eq(i.length-2),r=i.eq(i.length-1);s.length&&r.length&&!(s.find("input:eq(0)").val().trim()||s.find("input:eq(1)").val().trim()||s.find("input:eq(2)").val().trim())&&!(r.find("input:eq(0)").val().trim()||r.find("input:eq(1)").val().trim()||r.find("input:eq(2)").val().trim())&&r.remove()},a.prototype.mayBeAddDistanceRow=function(){this.templates.editDistanceRow=this.templates.editDistanceRow||c(c("#mapsvg-edit-distance-row").html());var e=this.views.edit.find(".mapsvg-edit-distance-row:last-child input");e&&e.last()&&e.last().val()&&e.last().val().trim().length&&this.templates.editDistanceRow.clone().insertAfter(this.views.edit.find(".mapsvg-edit-distance-row:last-child"));var t=this.views.edit.find(".mapsvg-edit-distance-row"),i=t.eq(t.length-2),a=t.eq(t.length-1);i.length&&a.length&&!i.find("input:eq(0)").val().trim()&&!a.find("input:eq(0)").val().trim()&&a.remove()},a.prototype.getSchema=function(){var t=this,i={type:this.type,db_type:this.db_type,label:this.label,name:this.name,value:this.value,searchable:d.parseBoolean(this.searchable)};if("select"==this.type&&(i.multiselect=d.parseBoolean(this.multiselect),i.multiselect&&(i.db_type="text"),i.optionsGrouped=this.optionsGrouped),this.options){var e=c.extend(!0,{},{options:this.options});i.options=e.options,i.optionsDict={},"region"==i.type?i.options.forEach(function(e){i.optionsDict[e.id]=e.title||e.id}):"status"==t.type?i.options.forEach(function(e,t){""===i.options[t].value?i.options.splice(t,1):(i.options[t].disabled=d.parseBoolean(i.options[t].disabled),i.optionsDict[e.value]=e)}):"distance"==t.type?i.options.forEach(function(e,t){""===i.options[t].value?i.options.splice(t,1):i.options[t].default=d.parseBoolean(i.options[t].default)}):i.options.forEach(function(e){i.optionsDict[e.value]="status"==t.type?e:e.label})}return this.help&&(i.help=this.help),this.button_text&&(i.button_text=this.button_text),"post"==this.type&&(i.post_type=this.post_type,i.add_fields=this.add_fields),"date"==this.type&&(i.language=this.language),"textarea"==this.type&&(i.autobr=this.autobr,i.html=this.html),"modal"==this.type&&(i.buttonText=this.buttonText),"distance"==this.type&&(i.distanceControl=this.distanceControl,i.distanceUnits=this.distanceUnits,i.distanceUnitsLabel=this.distanceUnitsLabel,i.fromLabel=this.fromLabel,i.addressField=this.addressField,i.addressFieldPlaceholder=this.addressFieldPlaceholder,i.userLocationButton=this.userLocationButton,i.placeholder=this.placeholder,"none"===i.distanceControl&&(i.distanceDefault=i.options.filter(function(e){return e.default})[0].value)),"search"==this.type&&(i.fallback=d.parseBoolean(this.fallback),i.placeholder=this.placeholder,i.noResultsText=this.noResultsText,i.width=this.width),this.checkboxLabel&&(i.checkboxLabel=this.checkboxLabel),this.checkboxValue&&(i.checkboxValue=this.checkboxValue),this.formBuilder.filtersMode&&(i.parameterName=this.parameterName,i.parameterNameShort=this.parameterName.split(".")[1],i.placeholder=this.placeholder),i.visible=void 0===this.visible||this.visible,i},a.prototype.get=function(){var e=this.getSchema();if(e._name=e.name,this.formBuilder.namespace){e.name=this.name.split("[")[0];var t=this.name.split("[")[1]||"";t&&(t="["+t),e.name=this.formBuilder.namespace+"["+e.name+"]"+t}return"post"==this.type&&(this.formBuilder.admin&&(e.post_types=this.formBuilder.admin.getPostTypes()),e.post_type=this.post_type,e.post=this.post,e.add_fields=this.add_fields||0),"date"==this.type&&(this.formBuilder.admin&&(e.languages=this.languages),e.language=this.language),"location"===this.type&&this.location&&(e.location=this.location,this.location.marker&&(e.location.img=(0===this.location.marker.src.indexOf(d.urls.uploads)?"uploads/":"")+this.location.marker.src.split("/").pop())),"textarea"==this.type&&(e.html=this.html),e.databaseFields=this.databaseFields,e.regionFields=this.regionFields,e.placeholder=this.placeholder,e},a.prototype.update=function(e,t){var i=this;if("options"==e){var a=[];t=t.split("\n").forEach(function(e){e=e.trim().split(":"),"checkbox"==i.type&&3==e.length?a.push({label:e[0],name:e[1],value:e[2]}):"radio"!=i.type&&"select"!=i.type||2!=e.length||a.push({label:e[0],value:e[1]})}),this.options=a}else this[e]=t;"parameterName"==e&&this.views.edit.find(".mapsvg-filter-param-name").text(t),this.redraw()},a.prototype.redraw=function(){var e=c(this.templates.result(this.get()));this.views.result.html(e.html()),c().mselect2&&("distance"!==this.type?this.views.result.find("select").css({width:"100%",display:"block"}).mselect2().on("select2:focus",function(){c(this).mselect2("open")}):this.views.result.find("select").mselect2().on("select2:focus",function(){c(this).mselect2("open")})),c().colorpicker&&this.views.edit&&this.views.edit.find(".cpicker").colorpicker().on("changeColor.colorpicker",function(e){""==c(this).find("input").val()&&c(this).find("i").css({"background-color":""})})};var t=function(e){var t=this;this.container=e.container,this.namespace=e.namespace,this.mediaUploader=e.mediaUploader,this.schema=e.schema||[],this.editMode=null!=e.editMode&&e.editMode,this.filtersMode=null!=e.filtersMode&&e.filtersMode,this.filtersHide=null!=e.filtersHide&&e.filtersHide,this.modal=null!=e.modal&&e.modal,this.admin=e.admin,this.mapsvg=e.mapsvg,this.data=e.data||{},this.eventHandlers=e.events,this.template="form-builder",this.closeOnSave=!0===e.closeOnSave,this.newRecord=!0===e.newRecord,this.types=e.types||["text","textarea","checkbox","radio","select","image","region","location","post","date"],this.templates={},this.elements={},this.view=c("<div />").addClass("mapsvg-form-builder"),this.editMode&&this.view.addClass("full-flex"),this.formControls=[],d.templatesLoaded[this.template]?this.init():c.get(d.urls.templates+t.template+".hbs?"+Math.random(),function(e){c(e).appendTo("body"),d.templatesLoaded[t.template]=!0,Handlebars.registerPartial("dataMarkerPartial",c("#mapsvg-data-tmpl-marker").html()),t.init()})};t.prototype.init=function(){var e=this;if(d.formBuilder=this,e.editMode){var t=Handlebars.compile(c("#mapsvg-form-editor-tmpl-ui").html());e.view.append(t({types:this.types})),e.view.addClass("edit")}else{var i=c('<div class="mapsvg-data-form-view"></div>');e.view.append(i),this.filtersMode||i.addClass("form-horizontal")}e.elements={buttons:{text:e.view.find("#mapsvg-data-btn-text"),textarea:e.view.find("#mapsvg-data-btn-textarea"),checkbox:e.view.find("#mapsvg-data-btn-checkbox"),radio:e.view.find("#mapsvg-data-btn-radio"),select:e.view.find("#mapsvg-data-btn-select"),image:e.view.find("#mapsvg-data-btn-image"),region:e.view.find("#mapsvg-data-btn-region"),marker:e.view.find("#mapsvg-data-btn-marker"),saveSchema:e.view.find("#mapsvg-data-btn-save-schema")},containers:{buttons_add:e.view.find("#mapsvg-data-buttons-add"),form_view:e.view.find(".mapsvg-data-form-view"),form_edit:e.view.find("#mapsvg-data-form-edit")}},e.redraw()},t.prototype.viewDidLoad=function(){_this.formControls.forEach(function(e){if(e.html){var t=e.views.result.find("textarea")[0];e.htmlEditor=CodeMirror.fromTextArea(t,{mode:{name:"handlebars",base:"text/html"},matchBrackets:!0,lineNumbers:!0})}})},t.prototype.setEventHandlers=function(){var p=this;c(e).off("keydown.form.mapsvg").on("keydown.form.mapsvg",function(e){d.formBuilder&&((e.metaKey||e.ctrlKey)&&13==e.keyCode?d.formBuilder.save():27==e.keyCode&&d.formBuilder.close())}),this.editMode?(this.view.on("click","#mapsvg-data-buttons-add button",function(e){e.preventDefault();var t=c(this).data("create");p.add({type:t})}),this.view.on("click","#mapsvg-data-btn-save-schema",function(e){e.preventDefault();var t=p.getSchema(),r={};p.formControls.forEach(function(e){r[e.name]=(r[e.name]||0)+1}),p.elements.containers.form_view.find(".form-group").removeClass("has-error");var o,n,l=[],d=["id","title","lat","lon","lng","location_lat","location_lon","location_lng","location_address","location_img","marker","marker_id","regions","region_id","post_id","post","post_title","post_url","keywords","status"],m={regions:"region",status:"status",post_id:"post",marker:"marker",location:"location"};p.formControls.forEach(function(e,t){var i=!1;if(!p.filtersMode)if(1<r[e.name])o||(o="Field names should be unique",l.push(o),i=!0);else if(0===e.name.length)n||(n="Field name can't be empty",l.push(n),i=!0);else if(-1!=d.indexOf(e.name)&&(!m[e.name]||m[e.name]&&m[e.name]!=e.type)){var a='Field name "'+e.name+'" is reserved, please set another name';l.push(a),i=!0}if(e.options&&"region"!=e.type&&"marker"!=e.type){var s=_.pluck(e.options,"value");s.length!=_.uniq(s).length&&(l.push('Check "Options" list - values should not repeat'),i=!0)}i&&e.views.result.addClass("has-error")}),0==l.length?p.eventHandlers.saveSchema&&p.eventHandlers.saveSchema(t):c.growl.error({title:"Errors",message:l.join("<br />")})}),setTimeout(function(){var e=p.elements.containers.form_view[0];p.sortable=new Sortable(e,{animation:150,onStart:function(){p.elements.containers.form_view.addClass("sorting")},onEnd:function(){setTimeout(function(){p.elements.containers.form_view.removeClass("sorting"),p.formControls=[],c(e).find(".form-group").each(function(e,t){p.formControls.push(c(t).data("formElement"))})},500)}})},1e3)):(p.view.on("click","button.btn-save",function(e){e.preventDefault(),p.save()}),p.view.on("click","button.btn-close",function(e){e.preventDefault(),p.close()})),new d.ResizeSensor(this.view[0],function(){p.scrollApi&&p.scrollApi.reinitialise()})},t.prototype.save=function(){var e=this;e.marker&&(e.marker.onChange=null,e.mapsvg.unsetEditingMarker());var t=e.getData();e.saved=!0,e.eventHandlers.save&&e.eventHandlers.save.call(e,t)},t.prototype.getData=function(){var i=this,e=i.toJSON(!0);return i.formControls.forEach(function(t){if("image"==t.type&&(e[t.name]=[],t.images&&t.images.length&&null!=t.images[0])){var a=[];t.views.result.find(".mapsvg-thumbnail-wrap").each(function(e,t){var i=c(t).data("image");a.push(i)}),t.images=a,e[t.name]=e[t.name].concat(t.images)}"location"==t.type&&(t.location?e[t.name]=t.location:e[t.name]=""),"post"==t.type&&(e.post=t.post),"region"==t.type&&(e.regions&&"object"==typeof e.regions&&e.regions.length?e.regions=e.regions.map(function(e){return{id:e,title:i.mapsvg.getRegion(e).title}}):e.regions=""),"select"==t.type&&t.multiselect&&e[t.name]&&e[t.name].length&&(e[t.name]=e[t.name].map(function(e){return{value:e,label:t.optionsDict[e]}}))}),null!=i.data.id&&(e.id=i.data.id),delete e.marker_id,e},t.prototype.getDataJSON=function(){var t=this,i=t.toJSON(!0);return t.formControls.forEach(function(e){if("image"==e.type&&(i[e.name]=[],e.images&&e.images.length&&null!=e.images[0])){var a=[];t.view.find(".mapsvg-thumbnail-wrap").each(function(e,t){var i=c(t).data("image");a.push(i)}),e.images=a,i[e.name]=i[e.name].concat(e.images)}"location"==e.type&&(i[e.name]=e.location)}),null!=t.data.id&&(i.id=t.data.id),i},t.prototype.redraw=function(e){var i=this;if(delete i.marker,i.container.empty(),i.elements.containers.form_view.empty(),i.formControls=[],i.data&&i.data.id&&i.add({type:"id",label:"ID",name:"id",value:i.data.id}),i.data&&i.data._title&&i.add({type:"title",label:"Title",name:"title",value:i.data._title}),i.schema&&i.schema.length&&i.schema.forEach(function(e){if(i.admin&&i.admin.isMetabox&&"post"==e.type);else{if(i.filtersMode?"distance"==e.type?e.value=i.data.distance?i.data.distance:void 0!==e.value?e.value:null:e.value=i.data[e.parameterNameShort]:e.value=i.data?i.data[e.name]:void 0!==e.value?e.value:null,"location"!=e.type||i.editMode?"post"==e.type&&(e.post=i.data.post):(e.value&&e.value.marker&&e.value.marker.id&&(i.marker=i.mapsvg.getMarker(e.value.marker.id).getOptions(),i.mapsvg.setEditingMarker(i.marker.id)),i.admin&&i.admin.setMode&&i.admin.setMode("editMarkers"),i.admin&&i.admin.enableMarkersMode(!0),i.mapsvg.setMarkerEditHandler(function(){i.marker=this.getOptions(),i.mapsvg.setEditingMarker(this.id),i.locationFormElement&&i.locationFormElement.renderMarker(i.mapsvg.getMarker(i.marker.id))})),i.filtersMode){if(!i.filtersHide||i.filtersHide&&i.modal&&"search"!==e.type||!i.modal&&"search"===e.type)var t=i.add(e)}else t=i.add(e);"location"==e.type&&(i.locationFormElement=t)}}),i.editMode||(0==this.schema.length?i.add({type:"empty"}):i.admin&&!i.admin.isMetabox&&i.add({type:"save"})),i.filtersMode&&i.filtersHide&&!i.modal&&i.add({type:"modal",buttonText:i.mapsvg.getData().options.filters.buttonText}),i.editMode||i.filtersMode)i.container.html(this.view);else{var t=c('<div class="nano"></div>'),a=c('<div class="nano-content"></div>');t.append(a),a.html(this.view),i.container.html(t),t.jScrollPane(),i.scrollApi=t.data("jsp")}i.eventHandlers.load&&i.eventHandlers.load(),this.editMode||i.filtersMode||this.view.find("input:visible,textarea:visible").not(".tt-hint").first().focus(),this.container.find(".CodeMirror").each(function(e,t){t&&t.CodeMirror.refresh()}),i.setEventHandlers(),i.eventHandlers.init&&i.eventHandlers.init(i.data)},t.prototype.delete=function(i){var a=this;a.formControls.forEach(function(e,t){e===i&&(a.formControls.splice(t,1),a.structureChanged=!0)})},t.prototype.add=function(t){if(-1!=["region","marker","post","status","distance","location","search"].indexOf(t.type)){var i=!1;if(this.formControls.forEach(function(e){e.type==t.type&&(i=!0)}),i)return void c.growl.error({title:"Error",message:'You can add only 1 "'+d.ucfirst(t.type)+'" field'})}"date"==t.type&&(d.datepicker=d.datepicker||{});var e=new a(t,this);return this.formControls.push(e),this.elements.containers.form_view.append(e.views.result),this.editMode&&this.edit(e),e},t.prototype.edit=function(e){var t=this;t.currentlyEditing&&t.currentlyEditing.destroyEditor(),t.elements.containers.form_edit.append(e.getEditor()),e.initEditor(),t.currentlyEditing=e,t.elements.containers.form_view.find(".form-group.active").removeClass("active"),e.views.result.addClass("active")},t.prototype.get=function(){return this.formControls.map(function(e){return e.get()})},t.prototype.getSchema=function(){return this.formControls.map(function(e){return e.getSchema()})},t.prototype.close=function(){var e=this;if(!e.saved){if(null==e.data.id&&e.marker){var t=e.mapsvg.getMarker(e.marker.id);t.onChange=null,t.delete(),delete e.marker}if(e.marker){var i=e.mapsvg.getEditingMarker();i&&(i.update(e.marker),e.mapsvg.unsetEditingMarker())}}if(e.markerSelector&&e.markerSelector.popover("destroy"),c().mselect2){var a=e.view.find(".mapsvg-select2");a.length&&a.mselect2("destroy")}var s=e.view.find(".CodeMirror");s.length&&s.empty().remove(),e.admin&&e.admin.enableMarkersMode(!1),d.formBuilder=null,e.eventHandlers.close&&e.eventHandlers.close()},t.prototype.destroy=function(){this.view.empty().remove(),this.sortable=null},t.prototype.on=function(e,t){this.eventHandlers[e]=t},t.prototype.toJSON=function(s){var t={};return this.elements.containers.form_view.find("input, textarea, select").each(function(){var e;c(this).data("skip")||c(this).prop("disabled")||!c(this).attr("name")||!s&&"checkbox"==c(this).attr("type")&&null==c(this).attr("checked")||"radio"==c(this).attr("type")&&null==c(this).attr("checked")||(e="checkbox"==c(this).attr("type")?c(this).prop("checked"):c(this).val(),function e(t,i,a){if(!s&&!a)return!1;1==i.length?t[i[0]]=a:(null==t[i[0]]&&(t[i[0]]={}),e(t[i[0]],i.slice(1),a))}(t,c(this).attr("name").replace(/]/g,"").split("["),e))}),t},t.prototype.getRegionsList=function(){return this.mapsvg.getData().regions.map(function(e){return{id:e.id,title:e.title}})},t.prototype.getMarkersList=function(){return this.mapsvg.getData().markers.map(function(e){return{id:e.id}})},d.FormBuilder=t}(jQuery,MapSVG,window);
!function(l,e){var t=function(e,t,l){this.name="google-maps",MapSVGAdminController.call(this,e,t,l),this.styles={default:{},silver:[{elementType:"geometry",stylers:[{color:"#f5f5f5"}]},{elementType:"labels.icon",stylers:[{visibility:"off"}]},{elementType:"labels.text.fill",stylers:[{color:"#616161"}]},{elementType:"labels.text.stroke",stylers:[{color:"#f5f5f5"}]},{featureType:"administrative.land_parcel",elementType:"labels.text.fill",stylers:[{color:"#bdbdbd"}]},{featureType:"poi",elementType:"geometry",stylers:[{color:"#eeeeee"}]},{featureType:"poi",elementType:"labels.text.fill",stylers:[{color:"#757575"}]},{featureType:"poi.park",elementType:"geometry",stylers:[{color:"#e5e5e5"}]},{featureType:"poi.park",elementType:"labels.text.fill",stylers:[{color:"#9e9e9e"}]},{featureType:"road",elementType:"geometry",stylers:[{color:"#ffffff"}]},{featureType:"road.arterial",elementType:"labels.text.fill",stylers:[{color:"#757575"}]},{featureType:"road.highway",elementType:"geometry",stylers:[{color:"#dadada"}]},{featureType:"road.highway",elementType:"labels.text.fill",stylers:[{color:"#616161"}]},{featureType:"road.local",elementType:"labels.text.fill",stylers:[{color:"#9e9e9e"}]},{featureType:"transit.line",elementType:"geometry",stylers:[{color:"#e5e5e5"}]},{featureType:"transit.station",elementType:"geometry",stylers:[{color:"#eeeeee"}]},{featureType:"water",elementType:"geometry",stylers:[{color:"#c9c9c9"}]},{featureType:"water",elementType:"labels.text.fill",stylers:[{color:"#9e9e9e"}]}],retro:[{elementType:"geometry",stylers:[{color:"#ebe3cd"}]},{elementType:"labels.text.fill",stylers:[{color:"#523735"}]},{elementType:"labels.text.stroke",stylers:[{color:"#f5f1e6"}]},{featureType:"administrative",elementType:"geometry.stroke",stylers:[{color:"#c9b2a6"}]},{featureType:"administrative.land_parcel",elementType:"geometry.stroke",stylers:[{color:"#dcd2be"}]},{featureType:"administrative.land_parcel",elementType:"labels.text.fill",stylers:[{color:"#ae9e90"}]},{featureType:"landscape.natural",elementType:"geometry",stylers:[{color:"#dfd2ae"}]},{featureType:"poi",elementType:"geometry",stylers:[{color:"#dfd2ae"}]},{featureType:"poi",elementType:"labels.text.fill",stylers:[{color:"#93817c"}]},{featureType:"poi.park",elementType:"geometry.fill",stylers:[{color:"#a5b076"}]},{featureType:"poi.park",elementType:"labels.text.fill",stylers:[{color:"#447530"}]},{featureType:"road",elementType:"geometry",stylers:[{color:"#f5f1e6"}]},{featureType:"road.arterial",elementType:"geometry",stylers:[{color:"#fdfcf8"}]},{featureType:"road.highway",elementType:"geometry",stylers:[{color:"#f8c967"}]},{featureType:"road.highway",elementType:"geometry.stroke",stylers:[{color:"#e9bc62"}]},{featureType:"road.highway.controlled_access",elementType:"geometry",stylers:[{color:"#e98d58"}]},{featureType:"road.highway.controlled_access",elementType:"geometry.stroke",stylers:[{color:"#db8555"}]},{featureType:"road.local",elementType:"labels.text.fill",stylers:[{color:"#806b63"}]},{featureType:"transit.line",elementType:"geometry",stylers:[{color:"#dfd2ae"}]},{featureType:"transit.line",elementType:"labels.text.fill",stylers:[{color:"#8f7d77"}]},{featureType:"transit.line",elementType:"labels.text.stroke",stylers:[{color:"#ebe3cd"}]},{featureType:"transit.station",elementType:"geometry",stylers:[{color:"#dfd2ae"}]},{featureType:"water",elementType:"geometry.fill",stylers:[{color:"#b9d3c2"}]},{featureType:"water",elementType:"labels.text.fill",stylers:[{color:"#92998d"}]}],dark:[{elementType:"geometry",stylers:[{color:"#212121"}]},{elementType:"labels.icon",stylers:[{visibility:"off"}]},{elementType:"labels.text.fill",stylers:[{color:"#757575"}]},{elementType:"labels.text.stroke",stylers:[{color:"#212121"}]},{featureType:"administrative",elementType:"geometry",stylers:[{color:"#757575"}]},{featureType:"administrative.country",elementType:"labels.text.fill",stylers:[{color:"#9e9e9e"}]},{featureType:"administrative.land_parcel",stylers:[{visibility:"off"}]},{featureType:"administrative.locality",elementType:"labels.text.fill",stylers:[{color:"#bdbdbd"}]},{featureType:"poi",elementType:"labels.text.fill",stylers:[{color:"#757575"}]},{featureType:"poi.park",elementType:"geometry",stylers:[{color:"#181818"}]},{featureType:"poi.park",elementType:"labels.text.fill",stylers:[{color:"#616161"}]},{featureType:"poi.park",elementType:"labels.text.stroke",stylers:[{color:"#1b1b1b"}]},{featureType:"road",elementType:"geometry.fill",stylers:[{color:"#2c2c2c"}]},{featureType:"road",elementType:"labels.text.fill",stylers:[{color:"#8a8a8a"}]},{featureType:"road.arterial",elementType:"geometry",stylers:[{color:"#373737"}]},{featureType:"road.highway",elementType:"geometry",stylers:[{color:"#3c3c3c"}]},{featureType:"road.highway.controlled_access",elementType:"geometry",stylers:[{color:"#4e4e4e"}]},{featureType:"road.local",elementType:"labels.text.fill",stylers:[{color:"#616161"}]},{featureType:"transit",elementType:"labels.text.fill",stylers:[{color:"#757575"}]},{featureType:"water",elementType:"geometry",stylers:[{color:"#000000"}]},{featureType:"water",elementType:"labels.text.fill",stylers:[{color:"#3d3d3d"}]}],night:[{elementType:"geometry",stylers:[{color:"#242f3e"}]},{elementType:"labels.text.fill",stylers:[{color:"#746855"}]},{elementType:"labels.text.stroke",stylers:[{color:"#242f3e"}]},{featureType:"administrative.locality",elementType:"labels.text.fill",stylers:[{color:"#d59563"}]},{featureType:"poi",elementType:"labels.text.fill",stylers:[{color:"#d59563"}]},{featureType:"poi.park",elementType:"geometry",stylers:[{color:"#263c3f"}]},{featureType:"poi.park",elementType:"labels.text.fill",stylers:[{color:"#6b9a76"}]},{featureType:"road",elementType:"geometry",stylers:[{color:"#38414e"}]},{featureType:"road",elementType:"geometry.stroke",stylers:[{color:"#212a37"}]},{featureType:"road",elementType:"labels.text.fill",stylers:[{color:"#9ca5b3"}]},{featureType:"road.highway",elementType:"geometry",stylers:[{color:"#746855"}]},{featureType:"road.highway",elementType:"geometry.stroke",stylers:[{color:"#1f2835"}]},{featureType:"road.highway",elementType:"labels.text.fill",stylers:[{color:"#f3d19c"}]},{featureType:"transit",elementType:"geometry",stylers:[{color:"#2f3948"}]},{featureType:"transit.station",elementType:"labels.text.fill",stylers:[{color:"#d59563"}]},{featureType:"water",elementType:"geometry",stylers:[{color:"#17263c"}]},{featureType:"water",elementType:"labels.text.fill",stylers:[{color:"#515c6d"}]},{featureType:"water",elementType:"labels.text.stroke",stylers:[{color:"#17263c"}]}],blue:[{elementType:"geometry",stylers:[{color:"#1d2c4d"}]},{elementType:"labels.text.fill",stylers:[{color:"#8ec3b9"}]},{elementType:"labels.text.stroke",stylers:[{color:"#1a3646"}]},{featureType:"administrative.country",elementType:"geometry.stroke",stylers:[{color:"#4b6878"}]},{featureType:"administrative.land_parcel",elementType:"labels.text.fill",stylers:[{color:"#64779e"}]},{featureType:"administrative.province",elementType:"geometry.stroke",stylers:[{color:"#4b6878"}]},{featureType:"landscape.man_made",elementType:"geometry.stroke",stylers:[{color:"#334e87"}]},{featureType:"landscape.natural",elementType:"geometry",stylers:[{color:"#023e58"}]},{featureType:"poi",elementType:"geometry",stylers:[{color:"#283d6a"}]},{featureType:"poi",elementType:"labels.text.fill",stylers:[{color:"#6f9ba5"}]},{featureType:"poi",elementType:"labels.text.stroke",stylers:[{color:"#1d2c4d"}]},{featureType:"poi.park",elementType:"geometry.fill",stylers:[{color:"#023e58"}]},{featureType:"poi.park",elementType:"labels.text.fill",stylers:[{color:"#3C7680"}]},{featureType:"road",elementType:"geometry",stylers:[{color:"#304a7d"}]},{featureType:"road",elementType:"labels.text.fill",stylers:[{color:"#98a5be"}]},{featureType:"road",elementType:"labels.text.stroke",stylers:[{color:"#1d2c4d"}]},{featureType:"road.highway",elementType:"geometry",stylers:[{color:"#2c6675"}]},{featureType:"road.highway",elementType:"geometry.stroke",stylers:[{color:"#255763"}]},{featureType:"road.highway",elementType:"labels.text.fill",stylers:[{color:"#b0d5ce"}]},{featureType:"road.highway",elementType:"labels.text.stroke",stylers:[{color:"#023e58"}]},{featureType:"transit",elementType:"labels.text.fill",stylers:[{color:"#98a5be"}]},{featureType:"transit",elementType:"labels.text.stroke",stylers:[{color:"#1d2c4d"}]},{featureType:"transit.line",elementType:"geometry.fill",stylers:[{color:"#283d6a"}]},{featureType:"transit.station",elementType:"geometry",stylers:[{color:"#3a4762"}]},{featureType:"water",elementType:"geometry",stylers:[{color:"#0e1626"}]},{featureType:"water",elementType:"labels.text.fill",stylers:[{color:"#4e6d70"}]}]}};e.MapSVGAdminGoogleMapsController=t,MapSVG.extend(t,e.MapSVGAdminController),t.prototype.viewLoaded=function(){this.mapsvg.getData().mapIsGeo||(this.view.find("#mapsvg-can-use-gmap").show(),this.view.find("form").css({opacity:.4,"pointer-events":"none"}))},t.prototype.setEventHandlers=function(){var o=this;MapSVG.GoogleMapBadApiKey=function(){alert('Google maps API key is incorrect. Change API key, click "Save" and RELOAD the page to reload Google maps scripts with correct API key.'),o.view.find("#googleMapsOn").prop("checked",!1).trigger("change")};var e=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.whitespace("formatted_address"),queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:ajaxurl+"?action=mapsvg_geocoding&address=%QUERY%",wildcard:"%QUERY%",transform:function(e){return e.error_message&&alert(e.error_message),e.results},rateLimitWait:500}}),t=o.view.find("#mapsvg-gm-address");t.typeahead(null,{name:"mapsvg-addresses",display:"formatted_address",source:e,minLength:2});t.on("typeahead:select",function(e,t){var l=t.geometry.bounds?t.geometry.bounds:t.geometry.viewport,r=new google.maps.LatLngBounds(l.southwest,l.northeast);o.mapsvg.getData().googleMaps.map.fitBounds(r)}),this.view.on("change",'input[name="googleMaps[style]"]',function(e){var t=l(this).val();"custom"==t?(o.view.find("#mapsvg-gm-custom-style-extra").show(),o.updateScroll(),l("#mapsvg-gm-custom-style-textarea").trigger("change")):(o.view.find("#mapsvg-gm-custom-style-extra").hide(),o.updateScroll(),o.mapsvg.getData().options.googleMaps.styleJSON=o.styles[t],o.mapsvg.getData().googleMaps.map.setOptions({styles:o.styles[t]}))}),this.view.on("change paste keyup","#mapsvg-gm-custom-style-textarea",function(e){try{var t=JSON.parse(l(this).val());o.mapsvg.getData().options.googleMaps.styleJSON=t,o.mapsvg.getData().googleMaps.map.setOptions({styles:t}),l("#mapsvg-gm-invalid-json").hide()}catch(e){console.log(e),l("#mapsvg-gm-invalid-json").show()}})}}(jQuery,window);
!function(o,a){var e=function(e,t,r){this.name="javascript",this.errorLines=[],this.disableHorizontalScroll=!0,this.scrollable=!1,MapSVGAdminController.call(this,e,t,r)};a.MapSVGAdminJavascriptController=e,MapSVG.extend(e,a.MapSVGAdminController),e.prototype.viewLoaded=function(){this.setEditor()},e.prototype.setEventHandlers=function(){var e=this;this.toolbarView.find("select").mselect2().on("select2:select",function(){e.setEditor()})},e.prototype.setEditor=function(){var e=this;this.view.find("#mapsvg-js-container").empty();var t=this.toolbarView.find("select").val(),r=o('<textarea id="mapsvg-js-textarea"  class="form-control" rows="8" data-live="change" name="events['+t+']"></textarea>'),i=this.mapsvg.getData().options.events[t];i||(i=""),i=i&&"string"!=typeof i?MapSVG.convertToText(this.mapsvg.getData().options.events[t]):i,r.val(i),this.view.find("#mapsvg-js-container").append(r),this.editor=CodeMirror.fromTextArea(r[0],{lint:!0,mode:"javascript",matchBrackets:!0,lineNumbers:!0}),this.editor.on("change",e.setTextareaValue),e.resizeEditor(),o(a).off("resize.codemirror.js"),o(a).on("resize.codemirror.js",function(){e.resizeEditor()})},e.prototype.resizeEditor=function(){this.view.find(".CodeMirror")[0].CodeMirror.setSize(null,this.contentWrap.height()),this.view.find(".CodeMirror").height(this.contentWrap.height())},e.prototype.setTextareaValue=function(e,t){var r=e.getValue();o(e.getTextArea()).val(r).trigger("change")},e.prototype.highlightErrors=function(){var e=this,t=o(e.editor.getTextArea()),r=e.editor.getValue();t.val(r),e.editor.operation(function(){e.error&&e.editor.removeLineClass(e.error.line-2,"background","line-error"),e.error=e.admin.validateInput(t),e.error instanceof TypeError||e.error instanceof SyntaxError?e.editor.addLineClass(e.error.line-2,"background","line-error"):(e.error=null,e.setTextareaValue())})}}(jQuery,window);
!function(t,i){var o=function(t,i,o){this.name="layers",this.scrollable=!1,this.isParent=!0,MapSVGAdminController.call(this,t,i,o)};i.MapSVGAdminLayersController=o,MapSVG.extend(o,i.MapSVGAdminController),o.prototype.viewLoaded=function(){this.controllers.list=new MapSVGAdminLayersListController("mapsvg-layers-list",this.admin,this.mapsvg),this.controllers.list.toolbarView=this.toolbarView},o.prototype.viewDidAppear=function(){MapSVGAdminController.prototype.viewDidAppear.call(this)},o.prototype.viewDidDisappear=function(){MapSVGAdminController.prototype.viewDidDisappear.call(this)},o.prototype.setEventHandlers=function(){}}(jQuery,window);
!function(l,e){var t=function(e,t,a){var i=this;this.name="layers-list",this.database=new MapSVG.DatabaseService({type:"local",dbObject:a.getData().options.groups},a),this.database.on("change",function(){i.mapsvg.setLayersControl()}),this.database.setSchema([{name:"id",label:"ID",visible:!0,type:"id"},{name:"objects",help:"You can select multiple objects",multiselect:!0,label:"Objects",visible:!0,type:"select",optionsGrouped:!0,options:a.getGroupSelectOptions()},{name:"title",label:"Title",visible:!0,type:"text"},{name:"visible",label:"Visible",visible:!1,type:"checkbox"}]),MapSVGAdminController.call(this,e,t,a)};e.MapSVGAdminLayersListController=t,MapSVG.extend(t,e.MapSVGAdminController),t.prototype.viewLoaded=function(){this.redrawDataList()},t.prototype.viewDidAppear=function(){MapSVGAdminController.prototype.viewDidAppear.call(this),this.database.setSchema()},t.prototype.viewDidDisappear=function(){MapSVGAdminController.prototype.viewDidDisappear.call(this),this.closeFormHandler()},t.prototype.setEventHandlers=function(){var i=this;l("#mapsvg-btn-layer-add").on("click",function(e){e.preventDefault(),i.btnAdd=l(this),i.btnAdd.addClass("disabled"),i.editDataRow()}),this.view.on("click",".mapsvg-data-row",function(e){l(this).hasClass("active")||i.editDataRow(l(this))}).on("click",".mapsvg-layer-view-toggle",function(e){e.preventDefault(),e.stopPropagation(),l(this).toggleClass("active");var t=l(this).closest("tr").data("id"),a=i.database.getLoadedObject(t);a.visible=!l(this).hasClass("active"),a.visible?(l(this).find("i").toggleClass("fa-eye",!0),l(this).find("i").toggleClass("fa-eye-slash",!1)):(l(this).find("i").toggleClass("fa-eye",!1),l(this).find("i").toggleClass("fa-eye-slash",!0)),i.mapsvg.setGroups(),i.mapsvg.setLayersControl()}).on("click",".mapsvg-layer-delete",function(e){e.preventDefault(),e.stopPropagation();var t=l(this).closest("tr");i.deleteDataRow(t)})},t.prototype.getTemplateData=function(){return{fields:this.getDataFieldsForTemplate(!0),data:this.database.getLoaded()}},t.prototype.getDataFieldsForTemplate=function(e){return[{name:"id",visible:!0,type:"id"},{name:"objects",visible:!0,type:"select",optionsGrouped:!0,options:this.mapsvg.getGroupSelectOptions()},{name:"title",visible:!0,type:"text"}]},t.prototype.redrawDataList=function(){var e=this;e.redraw();var t=this.mapsvg.getPagination(function(){e.redrawDataList()});this.view.find(".mapsvg-pagination-container").html(t)},t.prototype.getObjectRow=function(e){return this.view.find("#mapsvg-layer-row-"+e.id)},t.prototype.addDataRow=function(e){var t={fields:this.database.getColumns({visible:!0}),params:e},a=l(this.templates.item(t));return this.view.find("#mapsvg-layers-list-table tbody").prepend(a),a},t.prototype.updateDataRow=function(e,t){var a={fields:this.database.getColumns({visible:!0}),params:e},i=l(this.templates.item(a));(t=t||l("#mapsvg-layer-row-"+e.id)).replaceWith(i),i.addClass("mapsvg-row-updated"),setTimeout(function(){i.removeClass("mapsvg-row-updated")},2600)},t.prototype.deleteDataRow=function(e){var t=e.data("id"),a=this.database.getLoadedObject(t);if(!a)return!1;a.marker&&this.mapsvg.markerDelete(a.marker),this.database.delete(t),e.fadeOut(300,function(){e.remove()})},t.prototype.editDataRow=function(e,t){var a=this,i=!e,s={};if(a.tableDataActiveRow&&a.tableDataActiveRow.removeClass("mapsvg-row-selected"),e){a.updateScroll(),t&&a.contentWrap.data("jsp").scrollToElement(e,!0,!1),a.tableDataActiveRow=e,a.tableDataActiveRow.addClass("mapsvg-row-selected");var o=a.tableDataActiveRow.data("id");s=a.database.getLoadedObject(o)}else s={visible:!0};var r=wp.media.frames.file_frame=wp.media({title:"Choose images",button:{text:"Choose images"},multiple:!0});a.formBuilder&&(a.formBuilder.destroy(),a.formBuilder=null,a.formBuilderRow&&a.formBuilderRow.remove(),l("#mapsvg-btn-layer-add").removeClass("disabled")),a.formContainer&&a.formContainer.empty().remove(),a.formContainer=l('<div class="mapsvg-modal-edit"></div>'),this.view.append(a.formContainer),a.formBuilder=new MapSVG.FormBuilder({container:a.formContainer,schema:a.database.getSchema(),editMode:!1,mapsvg:a.mapsvg,mediaUploader:r,data:s,admin:a.admin,events:{save:function(e){i?(a.saveDataObject(e),this.redraw()):(a.updateDataObject(e),this.close())},close:function(){a.closeFormHandler()}}})},t.prototype.saveDataObject=function(e){var t,a,i=this;if(e.id&&(t=this.getObjectRow(e)),t&&t.length||(a=!0,t=this.addDataRow(e)),a)this.database.create(e).done(function(e){a&&i.updateDataRow(e,t)}).fail(function(){l.growl.error({title:"Server error",message:"Can't save object"}),t.remove()});else{if(this.database.update(e).fail(function(){l.growl.error({title:"Server error",message:"Can't update object"})}),e.marker){var s=i.mapsvg.getMarker(e.marker.id);s.setId("marker_"+e.id),s.setObject(e)}this.closeFormHandler(),this.updateDataRow(e)}},t.prototype.updateDataObject=function(e){if(this.database.update(e).fail(function(){l.growl.error({title:"Server error",message:"Can't update object"})}),e.marker){var t=this.mapsvg.getMarker(e.marker.id);t.setId("marker_"+e.id),t.setObject(e)}this.closeFormHandler(),this.updateDataRow(e)},t.prototype.closeFormHandler=function(){var e=this;l("#mapsvg-btn-layer-add").removeClass("disabled"),e.mapsvg.showMarkers(),e.formBuilder&&(e.formBuilder.destroy(),e.formBuilder=null,e.formContainer.empty().remove(),e.tableDataActiveRow&&e.tableDataActiveRow.removeClass("mapsvg-row-selected"),e.tableDataActiveRow&&!e.tableDataActiveRow.hasClass("mapsvg-row-updated")&&e.tableDataActiveRow.addClass("mapsvg-row-closed"),setTimeout(function(){e.tableDataActiveRow&&!e.tableDataActiveRow.hasClass("mapsvg-row-updated")&&e.tableDataActiveRow.removeClass("mapsvg-row-closed")},1600),l("a.browser").remove()),this.updateScroll()}}(jQuery,window);
!function(m,e){var t=function(e,t,a){this.name="markers",MapSVGAdminController.call(this,e,t,a)};e.MapSVGAdminMarkersController=t,MapSVG.extend(t,e.MapSVGAdminController),t.prototype.setEventHandlers=function(){var d=this;if(this.admin.hbData.isGeo){var e=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.whitespace("formatted_address"),queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:"//maps.googleapis.com/maps/api/geocode/json?address=%QUERY%&sensor=true",wildcard:"%QUERY%",transform:function(e){return e.results},rateLimitWait:600}});m("#mapsvg-geocode .typeahead").typeahead(null,{name:"mapsvg-addresses",display:"formatted_address",source:e,minLength:2});m("#mapsvg-geocode .typeahead").on("typeahead:select",function(e,t){var a=m("#mapsvg-geocode img").attr("src");d.mapsvg.markerAdd({src:a,geoCoords:[t.geometry.location.lat,t.geometry.location.lng]},!0),m("#mapsvg-geocode .typeahead").typeahead("val","")})}this.view.on("click","a.editable",function(){m(this).parent();var a=m(this),e=a.width();m(this).hide();var r=m(this).text(),s=m(this).closest("tr"),t=s.data("marker-id"),i=d.mapsvg.getMarker(t),o=m('<input class="editable" value="'+r+'"/>');o.width(e),o.insertBefore(m(this)),o.select();var n=a.data("field");o.on("blur",function(){if(text=m(this).val(),r!=text){if("id"==n){text=text.replace(" ","_");var e=d.mapsvg.checkId(text);if(e.error)return m().message(e.error),!1}var t={};t[n]=text,a.html(text),i.update(t),"id"==n&&(d.mapsvg.updateMarkersDict(),s.attr("id","mapsvg-marker-"+text),s.data("marker-id",text))}a.show(),m(this).off().remove()}).on("keypress",function(e){13!=e.which&&13!=event.keyCode||(e.preventDefault(),m(this).blur().trigger("blur"))})}).on("click",".mapsvg-marker-delete",function(e){e.preventDefault();var t=m(this).closest("tr"),a=t.data("marker-id"),r=d.mapsvg.getMarker(a);d.mapsvg.markerDelete(r),t.fadeOut(300,function(){m(this).remove()})}),m("#mapsvg-geocode .mapsvg-marker-image-btn-trigger img").attr("src",MapSVG.markerImages[0].url),this.view.on("click",".mapsvg-link-btn",function(e){e.preventDefault();var t=m(this).parent(),a=m(this),r=m(this).closest("tr").data("marker-id"),s=d.mapsvg.getMarker(r),i=s.href,o=m('<input class="link-editable form-control" value="'+(s.href||"")+'"/>');t.append(o),a.addClass("opened"),o.select(),o.on("blur",function(){var e=m(this).val();e!=i&&(s.update({href:e}),e.length?a.addClass("active"):a.removeClass("active")),m(this).off().remove(),a.removeClass("opened")}).on("keypress",function(e){13!=e.which&&13!=event.keyCode||(e.preventDefault(),m(this).blur().trigger("blur"))})}),m("#mapsvg-markers-search input#mapsvg-markers-search-1").on("keyup",function(){var e=m(this).data("t");e&&clearTimeout(e);var r=this;m(this).data("t",setTimeout(function(){var e=m(r).val();if(m("#mapsvg-search-markers-no-matches").hide(),e.length){var t=d.mapsvg.searchMarkers(e);if(m("#table-markers tr").hide(),0<t.length)for(var a in t)m("#table-markers tr#mapsvg-marker-"+t[a]).show();else m("#mapsvg-search-markers-no-matches").show()}else m("#table-markers tr").show()},300))})},t.prototype.addMarker=function(e){var t=m(this.templates.item(e));m("#table-markers").prepend(t)}}(jQuery,window);
!function(t,a,e){MetaboxAdmin=function(a){this.mapOptions=a.mapOptions,this.isMetabox=!0,this.mapSchema=a.mapSchema,this.mapId=a.mapId,this.view=t("#"+a.containerId),this.mapContainerId=a.mapContainerId,this.$map=t("#"+a.mapContainerId),this.mapTitle=a.mapTitle,this.markerImages=a.markerImages,e.markerImages=a.markerImages,e.defaultMarkerImage=e.markerImages[0].url,this.dataObject=a.dataObject||{},this.postTypes=a.postTypes||[],this.init()},e.MetaboxAdmin=MetaboxAdmin,MetaboxAdmin.prototype.init=function(){var t=this,a=wp.media.frames.file_frame=wp.media({title:"Choose images",button:{text:"Choose images"},multiple:!0});this.mapOptions.afterLoad=function(){t.dataObject.marker&&(t.dataObject.marker=this.markerAdd(t.dataObject.marker)),t.formBuilder=new e.FormBuilder(t.mapSchema,!1,t.mapsvg,a,t.dataObject,t,"mapsvg"),t.formBuilder.on("update",function(a){t.updateDataObject(a)}),t.formBuilder.view.appendTo(t.view.find(".mapsvg-metabox-form"))},this.mapsvg=this.$map.mapSvg(this.mapOptions)},MetaboxAdmin.prototype.getPostTypes=function(){return this.postTypes}}(jQuery,window,MapSVG);
!function(t,n){var o=function(t,n,o){this.name="modal",this.content="",MapSVGAdminController.call(this,t,n,o)};n.MapSVGAdminModalController=o,MapSVG.extend(o,n.MapSVGAdminController),o.prototype.setContent=function(t){this.content=t},o.prototype.getTemplateData=function(){return{content:this.content}}}(jQuery,window);
!function(a,t){var e=function(t,e,r){this.name="regions",this.scrollable=!1,this.isParent=!0,MapSVGAdminController.call(this,t,e,r)};t.MapSVGAdminRegionsController=e,MapSVG.extend(e,t.MapSVGAdminController),e.prototype.viewLoaded=function(){var t=this;this.controllers.list=new MapSVGAdminRegionsListController("mapsvg-regions-list",t.admin,t.mapsvg),this.controllers.structure=new MapSVGAdminRegionsStructureController("mapsvg-regions-structure",t.admin,t.mapsvg),this.controllers.csv=new MapSVGAdminRegionsCsvController("mapsvg-data-r-csv",t.admin,t.mapsvg),this.controllers.list.toolbarView=this.toolbarView,this.controllers.structure.toolbarView=this.toolbarView,this.controllers.csv.toolbarView=this.toolbarView,this.activeController=this.controllers.list,MapSVGAdminController.prototype.viewLoaded.call(this)},e.prototype.viewDidAppear=function(){MapSVGAdminController.prototype.viewDidAppear.call(this);var t=this;t.activeController&&t.activeController instanceof MapSVGAdminDatabaseStructureController&&(t.admin.rememberPanelsState(),t.admin.togglePanel("left",!1))},e.prototype.viewDidDisappear=function(){MapSVGAdminController.prototype.viewDidDisappear.call(this),this.admin.restorePanelsState()},e.prototype.setEventHandlers=function(){var i=this;a("#mapsvg-regions-menu a").click(function(t){t.preventDefault(),a(this).tab("show")}).on("shown.bs.tab",function(t){var e=a(a(this).attr("href")).data("controller");(i.activeController=e).viewDidAppear();var r=a(t.relatedTarget).attr("href");if(r){var o=a(r).attr("data-controller");i.controllers[o].viewDidDisappear()}"#mapsvg-regions-structure"==a(this).attr("href")?(i.admin.rememberPanelsState(),i.admin.togglePanel("left",!1)):i.admin.restorePanelsState()})}}(jQuery,window);
!function(t,e){var r=function(e,r,o){this.name="regions-csv",this.database=o.regionsDatabase,MapSVGAdminController.call(this,e,r,o)};e.MapSVGAdminRegionsCsvController=r,MapSVG.extend(r,e.MapSVGAdminController),r.prototype.setEventHandlers=function(){var o=this;this.view.find("#mapsvg-btn-r-csv-upload").on("click",function(){t(this);t("#mapsvg-r-csv-file")[0].files[0]?Papa.parse(t("#mapsvg-r-csv-file")[0].files[0],{header:!0,complete:function(e){if(0===e.errors.length)o.import(e.data);else{var r="Errors: \n";r+=e.errors.map(function(e){return e.message+(void 0!==e.row?" (row: "+e.row+")":"")}).slice(0,5).join("\n"),5<e.errors.length&&(r+="\n...and "+(e.errors.length-5)+" more. "),alert(r)}}}):t.growl.error({title:"",message:"Please choose a file"})})},r.prototype.import=function(e){var r=t("#mapsvg-btn-r-csv-upload");r._button("loading");this.database.import(e).done(function(e){t.growl.notice({title:"",message:"File uploaded"})}).always(function(){r._button("reset")}).fail(function(){t.growl.error({title:"",message:"Server error"})})}}(jQuery,window);
!function(l,i){var e=function(e,t,a){var i=this;this.name="regions-list",this.database=a.regionsDatabase,i.database.on("schemaChange",function(){i.redrawDataList()}),i.database.on("dataLoaded",function(){i.redrawDataList()}),MapSVGAdminController.call(this,e,t,a)};i.MapSVGAdminRegionsListController=e,MapSVG.extend(e,i.MapSVGAdminController),e.prototype.viewLoaded=function(){var e=this.database.getColumns();this.databaseTimestamp=Date.now();var t=this.toolbarView.find(".mapsvg-data-cols");t.empty(),e.forEach(function(e){t.append(l('<li class="'+(e.visible?"active":"")+'"><a href="#" data-field="'+e.name+'">'+e.name+"</a></li>"))})},e.prototype.getTemplateData=function(){var e=this,t=e.database.getLoaded(),a=e.mapsvg.getData().options.regions;return t.forEach(function(e){e.fill=a&&a[e.id]&&a[e.id].fill?a[e.id].fill:null}),{fields:e.getDataFieldsForTemplate(!0),data:t}},e.prototype.getDataFieldsForTemplate=function(t){var a=[{name:"id",visible:!0,type:"id"},{name:"title",visible:!0,type:"id"}],e=this.database.getSchema();return e&&e.forEach(function(e){return t?e.visible?a.push(e):void 0:a.push(e)}),a},e.prototype.setEventHandlers=function(){var t,n=this;this.toolbarView.on("click",".mapsvg-data-cols a",function(e){e.preventDefault(),l(this).closest("li").toggleClass("active");var t=n.database.getSchema(),a=l(this).data("field");for(var i in t)a==t[i].name&&(t[i].visible=!t[i].visible);n.database.saveSchema(t)}),this.view.on("click",".region-cpicker",function(e){e.preventDefault(),setTimeout(function(){n.view.addClass("mapsvg-cpicker-opened")},200);var o=l(this);n.colorpickerRegionBtn&&n.colorpickerRegionBtn.colorpicker("destroy"),n.colorpickerRegionBtn=o,n.colorpickerRegionId=l(this).closest(".mapsvg-data-row").data("region-id");var t=n.mapsvg.getOptions().regions[n.colorpickerRegionId],a=t?t.fill:"";n.colorpicker=o.colorpicker({template:'<div class="colorpicker dropdown-menu"><div class="colorpicker-saturation"><i><b></b></i></div><div class="colorpicker-hue"><i></i></div><div class="colorpicker-alpha"><i></i></div><div class="colorpicker-input-wrap"><input class="colorpicker-input" type="text"/><i></i></div><div class="colorpicker-reset-wrap"><button class="btn btn-xs btn-default colorpicker-reset">Reset</button><i></i></div></div>'}).colorpicker("show");var s=l(".colorpicker-input");l(".colorpicker-reset").on("click",function(){var e=n.colorpickerRegionId;n.mapsvg.getRegion(e).setFill(""),s.val(""),o.css({background:""}),o.colorpicker("destroy")}),a&&s.val(a),s.on("focus",function(){s.focused=!0}),s.on("blur",function(){s.focused=!1}),s.on("keyup paste",function(){var e=l(this).val();o.colorpicker("setValue",e)}),o.colorpicker().on("changeColor",function(e){var t,a=n.colorpickerRegionId,i=e.color.toRGB();t=1===i.a?e.color.toHex():"rgba("+i.r+","+i.g+","+i.b+","+i.a+")",n.mapsvg.getRegion(a).setFill(t),s.focused||s.val(t),o.css({background:t})}),a&&o.colorpicker("setValue",a),l(i).on("mousedown.colorpicker",function(e){l(e.target).not("input")&&(n.view.removeClass("mapsvg-cpicker-opened"),s.blur())})}),l("body").on("click",".colorpicker-input",function(){}),this.view.on("click",".mapsvg-link-btn",function(e){e.preventDefault();var t=l(this).parent(),a=l(this),i=l(this).closest("tr").data("region-id"),o=n.mapsvg.getRegion(i),s=o.href,r=l('<input class="link-editable form-control" value="'+(o.href||"")+'"/>');t.append(r),a.addClass("opened"),r.select(),r.on("blur",function(){var e=l(this).val();e!=s&&(o.update({href:e}),e.length?a.addClass("active"):a.removeClass("active")),l(this).off().remove(),a.removeClass("opened")}).on("keypress",function(e){13!=e.which&&13!=event.keyCode||(e.preventDefault(),l(this).blur().trigger("blur"))})}),l("#mapsvg-regions-search").on("keyup",function(){t&&clearTimeout(t);var e=this;t=setTimeout(function(){n.mapsvg.regionsDatabase.getAll({filters:{search:l(e).val()},searchFallback:!0}),n.redrawDataList()},300)}),this.view.on("mouseover",".mapsvg-data-row",function(){var e=l(this).data("region-id"),t=n.mapsvg.getRegion(e);t.selected||t.highlight()}).on("mouseout",".mapsvg-data-row",function(){var e=l(this).data("region-id"),t=n.mapsvg.getRegion(e);t.selected||t.unhighlight()}).on("click",".mapsvg-data-row",function(e){var t=l(e.target),a=l(this).data("region-id");if(!t.is(".btn")&&!t.parent().is(".btn"))if(void 0!==t.data("set-status")){var i=n.mapsvg.getRegion(a).data,o=t.data("set-status")+"";i.status=o,n.updateDataObject(i),t.closest("ul").find("li").removeClass("active"),t.parent().addClass("active"),t.closest("td").find(".mapsvg-status-text").html(t.text())}else{var s=n.mapsvg.getRegion(a);n.editRegion(s)}}),this.view.on("click",".mapsvg-data-btn",function(e){e.preventDefault();var t=l(this).closest("tr").data("region-id");l('#mapsvg-tabs-menu a[href="#tab_database"]').tab("show"),l("#mapsvg-data-search").val(t).trigger("keyup")})},e.prototype.updateDataRow=function(e,t){e.id_no_spaces=e.id.split(" ").join("_");var a=this.mapsvg.getData().options.regions,i={fields:this.database.getColumns({visible:!0}),params:e};i.id=e.id,i.id_no_spaces=e.id_no_spaces,i.fill=a&&a[i.id]&&a[i.id].fill?a[i.id].fill:null;var o=l(this.templates.item(i));(t=t||l("#mapsvg-region-"+e.id_no_spaces.replace(/(:|\(|\)|\.|\[|\]|,|=|@)/g,"\\$1"))).replaceWith(o),o.addClass("mapsvg-row-updated"),setTimeout(function(){o.removeClass("mapsvg-row-updated")},2600)},e.prototype.editRegion=function(e,t){var a=this,i=a.view.find("#mapsvg-region-"+e.id_no_spaces.replace(/(:|\(|\)|\.|\[|\]|,|=|@)/g,"\\$1"));a.tableDataActiveRow&&a.tableDataActiveRow.removeClass("mapsvg-row-selected"),e.selected||a.mapsvg.selectRegion(e);var o={};i&&(a.updateScroll(),t&&a.contentWrap.data("jsp").scrollToElement(i,!0,!1),a.tableDataActiveRow=i,a.tableDataActiveRow.addClass("mapsvg-row-selected"),l.extend(o,e.data,{id:e.id})),o._title=e.title,obj=o;var s=wp.media.frames.file_frame=wp.media({title:"Choose images",button:{text:"Choose images"},multiple:!0});a.formBuilder&&(a.formBuilder.destroy(),a.formBuilder=null,a.formBuilderRow&&a.formBuilderRow.remove()),a.formContainer&&a.formContainer.empty().remove(),a.formContainer=a.formContainer||l('<div class="mapsvg-modal-edit"></div>'),this.view.append(a.formContainer),obj.id,a.formBuilder=new MapSVG.FormBuilder({container:a.formContainer,schema:a.database.getSchema(),editMode:!1,mapsvg:a.mapsvg,mediaUploader:s,data:obj,admin:a.admin,events:{save:function(e){a.updateDataObject(e),this.close()},close:function(){a.closeFormHandler()}}})},e.prototype.updateDataObject=function(e){var t=this.mapsvg.getRegion(e.id),a={data:e};e.status&&(a.status=e.status),t.update(a),e.region_title=t.title||"",this.database.update(e).fail(function(){l.growl.error({title:"Server error",message:"Can't update region"})}),e.title=t.title||"",this.closeFormHandler(),this.updateDataRow(t.data)},e.prototype.closeFormHandler=function(){var e=this;e.formBuilder&&(e.formBuilder.destroy(),e.formBuilder=null,e.formContainer.empty().remove(),e.formBuilderRow&&e.formBuilderRow.remove()),l("a.browser").remove()},e.prototype.viewDidAppear=function(){MapSVGAdminController.prototype.viewDidAppear.call(this),this.databaseTimestamp<this.database.lastChangeTime&&this.redrawDataList()},e.prototype.viewDidDisappear=function(){MapSVGAdminController.prototype.viewDidDisappear.call(this),this.closeFormHandler()},e.prototype.redrawDataList=function(){this.redraw();var e=this.database.getColumns(),t=this.toolbarView.find(".mapsvg-data-cols");t.empty(),e.forEach(function(e){t.append(l('<li class="'+(e.visible?"active":"")+'"><a href="#" data-field="'+e.name+'">'+e.name+"</a></li>"))})}}(jQuery,window);
!function(a,t){var e=function(t,e,a,i){this.name="regions-structure",this.scrollable=!1,this.database=a.regionsDatabase,MapSVGAdminController.call(this,t,e,a)};t.MapSVGAdminRegionsStructureController=e,MapSVG.extend(e,t.MapSVGAdminController),e.prototype.viewDidAppear=function(){var e=this;MapSVGAdminController.prototype.viewDidAppear.call(this),e.formBuilder=new MapSVG.FormBuilder({schema:e.database.getSchema(),editMode:!0,mapsvg:e.mapsvg,admin:e.admin,container:this.contentView,types:["text","textarea","checkbox","radio","select","image","status","date"],events:{saveSchema:function(t){e.database.saveSchema(t).done(function(){(_status=e.database.getSchemaField("status"))&&(e.mapsvg.setRegionStatuses(_status.optionsDict),e.admin.save(!0)),a.growl.notice({title:"",message:"Settings saved"})}).fail(function(){a.growl.error({title:"Server error",message:"Can't save settings"})})},load:function(){setTimeout(function(){a("#mapsvg-btn-regions-structure").tooltip("show").tooltip("hide")},200)}}})},e.prototype.viewDidDisappear=function(){MapSVGAdminController.prototype.viewDidDisappear.call(this),this.formBuilder&&this.formBuilder.destroy()},e.prototype.setEventHandlers=function(){}}(jQuery,window);
!function(s,v){var t=function(t,e,a){this.name="settings",MapSVGAdminController.call(this,t,e,a)};v.MapSVGAdminSettingsController=t,MapSVG.extend(t,v.MapSVGAdminController),t.prototype.viewLoaded=function(){var e=this;this.view.find(".mapsvg-select2").mselect2(),e.updateGaugeFields(),e.mapsvg.regionsDatabase.on("schemaChange",function(){e.updateGaugeFields()}),zoomLimit=e.mapsvg.getData().options.zoom.limit,s("#mapsvg-controls-zoomlimit").ionRangeSlider({type:"double",grid:!0,min:-100,max:100,from_min:-100,from_max:0,to_min:1,to_max:100,onFinish:function(){var t=s("#mapsvg-controls-zoomlimit").val().split(";");e.mapsvg.update({zoom:{limit:[t[0],t[1]]}})},from:zoomLimit[0],to:zoomLimit[1]})},t.prototype.setEventHandlers=function(){var i=this;function e(t,e){var o="default"==t?mapsvg_paths.maps+e:mapsvg_paths.uploads+e;s.get(o,function(t){var e=s(t).find("svg"),a={svgDefault:{}};if(a.$svg=e,a.svgDefault.width=e.attr("width"),a.svgDefault.height=e.attr("height"),a.svgDefault.viewBox=e.attr("viewBox"),a.svgDefault.width&&a.svgDefault.height)a.svgDefault.width=parseFloat(a.svgDefault.width.replace(/px/g,"")),a.svgDefault.height=parseFloat(a.svgDefault.height.replace(/px/g,"")),a.svgDefault.viewBox=a.svgDefault.viewBox?a.svgDefault.viewBox.split(" "):[0,0,a.svgDefault.width,a.svgDefault.height];else{if(!a.svgDefault.viewBox)return alert("MapSVG needs width/height or viewBox parameter to be present in SVG file."),!1;a.svgDefault.viewBox=a.svgDefault.viewBox.split(" "),a.svgDefault.width=parseFloat(a.svgDefault.viewBox[2]),a.svgDefault.height=parseFloat(a.svgDefault.viewBox[3])}i.mapsvg.update({source:o,viewBox:a.svgDefault.viewBox,width:a.svgDefault.width,height:a.svgDefault.height}),i.admin.save(!0).done(function(){v.location.reload()})})}s("#mapsvg-controls-width").on("keyup",function(t){i.setHeight(t)}),s("#mapsvg-controls-height").on("keyup",function(t){i.setWidth(t)}),s("#mapsvg-controls-ratio").on("change",function(t){i.keepRatioClickHandler(t)}),s("#mapsvg-controls-set-viewbox").on("click",function(t){t.preventDefault();var e=i.mapsvg.getViewBox();s("#mapsvg-controls-viewbox").val(e.join(" ")).trigger("change")}),s("#mapsvg-controls-reset-viewbox").on("click",function(t){t.preventDefault();var e=i.mapsvg.getData().svgDefault.viewBox;s("#mapsvg-controls-viewbox").val(e.join(" ")).trigger("change"),i.mapsvg.viewBoxReset()}),s("#mapsvg-controls-zoom").on("change",":radio",function(){MapSVG.parseBoolean(s("#mapsvg-controls-zoom :radio:checked").val())?s("#mapsvg-controls-zoom-options").show():s("#mapsvg-controls-zoom-options").hide(),i.admin.updateScroll()}),s("#mapsvg-controls-scroll").on("change",":radio",function(){MapSVG.parseBoolean(s("#mapsvg-controls-scroll :radio:checked").val())?s("#mapsvg-controls-scroll-options").show():s("#mapsvg-controls-scroll-options").hide(),i.admin.updateScroll()}),this.view.find("#mapsvg-gauge-control").on("change",":radio",function(){MapSVG.parseBoolean(s("#mapsvg-gauge-control").find(":radio:checked").val())?s("#table-regions").addClass("mapsvg-gauge-on"):s("#table-regions").removeClass("mapsvg-gauge-on")}),this.view.on("click","#mapsvg-set-prefix-btn",function(t){t.preventDefault(),i.admin.save().done(function(){v.location.reload()})}),this.view.on("click","#mapsvg-controls-file-remove",function(t){e("default","geo-calibrated/empty.svg")}),this.view.on("click","#mapsvg-controls-file-reload",function(t){i.mapsvg.getData().options.svgFileVersion++,i.admin.save(!0).done(function(){v.location.reload()})}),this.view.on("click","#mapsvg-controls-file-change",function(t){s("#mapsvg-hidden-file-select").show()}),this.view.on("click","#mapsvg-controls-file-hide",function(t){t.preventDefault(),s("#mapsvg-hidden-file-select").hide()}),this.view.find("#mapsvg-select2-map").mselect2().on("select2:select",function(){e(s(this).find("option:selected").data("package"),s(this).find("option:selected").data("path"))}),this.mapsvg.on("sizeChange",function(){i.admin.resizeDashboard()})},t.prototype.setWidth=function(){var t=this,e=s("#mapsvg-controls-width").val(),a=s("#mapsvg-controls-height").val();s("#mapsvg-controls-ratio").is(":checked")&&(e=Math.round(a*t.mapsvg.getData().svgDefault.width/t.mapsvg.getData().svgDefault.height),s("#mapsvg-controls-width").val(e)),t.mapsvg.viewBoxSetBySize(e,a),t.admin.resizeDashboard()},t.prototype.setHeight=function(){var t=this,e=s("#mapsvg-controls-width").val(),a=s("#mapsvg-controls-height").val();s("#mapsvg-controls-ratio").is(":checked")&&(a=Math.round(e*t.mapsvg.getData().svgDefault.height/t.mapsvg.getData().svgDefault.width),s("#mapsvg-controls-height").val(a)),t.mapsvg.viewBoxSetBySize(e,a),t.admin.resizeDashboard()},t.prototype.keepRatioClickHandler=function(){s("#mapsvg-controls-ratio").is(":checked")&&this.setHeight()},t.prototype.setWidthViewbox=function(){var t=this;if(s("#mapsvg-controls-ratio").is(":checked"))var e=t.mapsvg.getData().svgDefault.width/t.mapsvg.getData().svgDefault.height;else e=s("#map_width").val()/s("#map_height").val();var a=Math.round(s("#viewbox_height").val()*e);if(a>t.mapsvg.getData().svgDefault.viewBox[2]){a=t.mapsvg.getData().svgDefault.viewBox[2];var o=t.mapsvg.getData().svgDefault.viewBox[3]*e;s("#viewbox_height").val(o)}s("#viewbox_width").val(a)},t.prototype.setViewBoxRatio=function(){var t=s("#map_width").val()/s("#map_height").val(),e=s("#viewbox_width").val()/s("#viewbox_height").val();t!=e&&(e<=t?s("#viewbox_height").val(this.mapsvg.getData().svgDefault.viewBox[2]*t):s("#viewbox_width").val(this.mapsvg.getData().svgDefault.viewBox[3]/t))},t.prototype.setHeightViewbox=function(){var t=this;if(s("#mapsvg-controls-ratio").is(":checked"))var e=t.mapsvg.getData().svgDefault.height/t.mapsvg.getData().svgDefault.width;else e=s("#map_height").val()/s("#map_width").val();var a=Math.round(s("#viewbox_width").val()*e);if(a>t.mapsvg.getData().svgDefault.viewBox[3]){a=t.mapsvg.getData().svgDefault.viewBox[3];var o=t.mapsvg.getData().svgDefault.viewBox[2]*e;s("#viewbox_width").val(o)}s("#viewbox_height").val(a)},t.prototype.updateGaugeFields=function(){var t=this.mapsvg.regionsDatabase.getSchema(),e=this.mapsvg.getOptions().regionChoroplethField,a=this.view.find("#mapsvg-region-data-fields").empty();a.append("<option></option>"),t.forEach(function(t){a.append("<option "+(e==t.name?"selected":"")+">"+t.name+"</option>")}),a.trigger("change")}}(jQuery,window);
!function(a,e){var t=function(t,e,s){this.name="templates",this.disableHorizontalScroll=!0,MapSVGAdminController.call(this,t,e,s)};e.MapSVGAdminTemplatesController=t,MapSVG.extend(t,e.MapSVGAdminController),t.prototype.viewDidAppear=function(){this.setHints()},t.prototype.viewLoaded=function(){var t=this;t.setEditor(),a(e).on("resize.codemirror.tmpl",function(){t.resizeEditor()})},t.prototype.setEventHandlers=function(){var t=this;this.toolbarView.find("select").mselect2().on("change",function(){t.setEditor()})},t.prototype.setEditor=function(){this.view.find("#mapsvg-template-container").empty(),this.template=this.toolbarView.find("select").val();var t=a('<textarea id="mapsvg-template-textarea" class="form-control" rows="8" name="templates['+this.template+']" data-live="change"></textarea>');t.val(this.mapsvg.getData().options.templates[this.template]),this.view.find("#mapsvg-template-container").append(t),this.setHints(),this.editor=CodeMirror.fromTextArea(t[0],{mode:{name:"handlebars",base:"text/html"},matchBrackets:!0,lineNumbers:!0}),this.editor.on("change",this.setTextareaValue),this.editor.on("inputRead",function(t,e){"{"==e.text[0]&&t.showHint({completeSingle:!1})}),this.resizeEditor()},t.prototype.resizeEditor=function(){this.view.find(".CodeMirror")[0].CodeMirror.setSize(null,this.contentWrap.height()),this.view.find(".CodeMirror").height(this.contentWrap.height())},t.prototype.getRegionHints=function(t){var e=t?"regions.0.":"",s=[];return s.push("{"+e+"id}}"),s.push("{"+e+"title}}"),this.mapsvg.regionsDatabase.getSchema().forEach(function(t){"image"==t.type?(s.push("{"+e+t.name+".0.thumbnail}}"),s.push("{"+e+t.name+".0.medium}}"),s.push("{"+e+t.name+".0.full}}")):"post"==t.type?(s.push("{"+e+"post.post_title}}"),s.push("{"+e+"post.content}}"),s.push("{"+e+"post.url}}")):(("select"==t.type||"radio"==t.type||"status"==t.type)&&s.push("{"+e+t.name+"_text}}"),s.push("{"+e+t.name+"}}"))}),t||(s=s.concat(this.getDBHints(!0))),s},t.prototype.getDBHints=function(e){var s=e?"objects.0.":"",a=[];a.push("{"+s+"id}}");var i=this;return this.mapsvg.database.getSchema().forEach(function(t){"post"==t.type?(a.push("{"+s+"post.post_title}}"),a.push("{"+s+"post.post_content}}"),a.push("{"+s+"post.url}}")):"location"==t.type?i.mapsvg.getData().mapIsGeo&&(a.push("{"+t.name+".address.formatted}}"),a.push("{"+t.name+".address.locality}}"),a.push("{"+t.name+".address.state}}"),a.push("{"+t.name+".address.state_short}}"),a.push("{"+t.name+".address.street_number}}"),a.push("{"+t.name+".address.route}}"),a.push("{"+t.name+".address.administrative_area_1}}"),a.push("{"+t.name+".address.administrative_area_1_short}}"),a.push("{"+t.name+".address.administrative_area_2}}"),a.push("{"+t.name+".address.administrative_area_2_short}}"),a.push("{"+t.name+".address.country}}"),a.push("{"+t.name+".address.zip}}"),a.push("{"+t.name+".address.postal_code}}"),a.push("{"+t.name+".lat}}"),a.push("{"+t.name+".lng}}")):"marker"==t.type?i.mapsvg.getData().mapIsGeo&&(a.push("{marker.geoCoords.[0]}}"),a.push("{marker.geoCoords.[1]}}")):"image"==t.type?(a.push("{"+s+t.name+".0.thumbnail}}"),a.push("{"+s+t.name+".0.medium}}"),a.push("{"+s+t.name+".0.full}}")):"region"==t.type?e||(a=a.concat(i.getRegionHints(!0))):(("select"==t.type||"radio"==t.type)&&a.push("{"+s+t.name+"_text}}"),a.push("{"+s+t.name+"}}"))}),a},t.prototype.setHints=function(){var t=("popoverRegion"==this.template||"tooltipRegion"==this.template||"detailsViewRegion"==this.template||"directoryItem"==this.template&&"regions"==this.mapsvg.getData().options.menu.source?this.getRegionHints():this.getDBHints()).concat([]);CodeMirror.registerHelper("hintWords","xml",t)},t.prototype.setTextareaValue=function(t,e){var s=t.getValue();a(t.getTextArea()).val(s).trigger("change")},t.prototype.init=function(){}}(jQuery,window);